<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<title>‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}
body {
font-family: 'Kalpurush', 'SolaimanLipi', Arial, sans-serif;
padding: 0;
background: #f5f5f5;
}
input, button, select, textarea {
font-family: inherit;
}
.main-wrapper {
max-width: 1400px;
margin: 20px auto;
box-shadow: 0 2px 10px rgba(0,0,0,0.1);
background: white;
display: flex;
min-height: 90vh;
}
.sidebar {
width: 250px;
background-color: #3A358E;
color: white;
padding: 20px 0;
flex-shrink: 0;
}
.sidebar-header {
font-size: 18px;
font-weight: bold;
text-align: center;
margin-bottom: 20px;
padding-bottom: 10px;
border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}
.sidebar ul {
list-style: none;
padding: 0;
margin: 0;
}
.sidebar ul li a {
display: block;
padding: 12px 20px;
color: white;
text-decoration: none;
transition: background-color 0.3s;
}
.sidebar ul li a:hover,
.sidebar ul li a.active {
background-color: #2c286e;
border-left: 5px solid #1abc9c;
}
.main-content {
flex-grow: 1;
padding: 20px;
overflow-y: auto;
}
.container {
background: white;
padding: 30px;
box-shadow: 0 2px 10px rgba(0,0,0,0.1);
overflow-x: auto;
position: relative;
}
.header {
text-align: center;
margin-bottom: 10px;
border-bottom: 3px solid #3A358E;
padding-bottom: 10px;
}
.header h1 {
font-size: 24px;
margin-bottom: 10px;
color: #3A358E;
}
.header h2 {
font-size: 18px;
color: #3A358E;
}
.header .info-line {
display: flex;
justify-content: center;
align-items: center;
margin-top: 15px;
padding: 0 10px;
flex-wrap: wrap;
gap: 30px;
}
.header .field-group {
display: flex;
align-items: center;
margin: 5px 0;
}
.header .field-group.center-group {
justify-content: center;
flex-grow: 1;
text-align: center;
}
.header .field-group label {
font-weight: bold;
margin-right: 5px;
white-space: nowrap;
}
.header .field-group input {
padding: 5px;
border: 1px solid #3A358E;
border-radius: 4px;
}
.header .field-group.date-range label {
width: auto;
margin-left: 0px;
margin-right: 10px;
}
.header .field-group.date-range {
gap: 15px;
}
.main-sections-wrapper {
display: block;
gap: 30px;
margin-bottom: 10px;
}
.expense-section {
flex-grow: 1;
min-width: unset;
margin-bottom: 0;
}
.expense-section .section-title {
min-width: 100%;
display: table;
}
.section-title {
background: #3A358E;
color: white;
padding: 12px;
font-size: 16px;
font-weight: bold;
margin-bottom: 15px;
}
table {
width: 100%;
border-collapse: collapse;
margin-bottom: 20px;
font-size: 13px;
table-layout: auto;
}
th, td {
border: 1px solid #3A358E;
padding: 8px;
text-align: center;
font-weight: bold;
white-space: normal !important;
word-wrap: break-word !important;
}
th {
background: #3A358E;
color: white;
font-weight: bold;
}
.expense-table {
overflow-x: auto;
}
.expense-table table {
width: 100%;
table-layout: auto;
}
.expense-table th.normal {
writing-mode: horizontal-tb;
font-size: 11px;
padding: 8px 5px;
line-height: 1.3;
white-space: normal;
word-wrap: break-word;
font-weight: bold;
}
.expense-table td {
}
input[type="number"], input[type="text"], input[type="date"] {
width: 100%;
border: none;
background: transparent;
text-align: center;
font-family: 'Kalpurush', 'SolaimanLipi', Arial, sans-serif !important; 
}
.static-cell {
padding: 8px;
text-align: center;
border: 1px solid #3A358E;
}
.ok-cell {
background: #d4edda;
color: #155724;
font-weight: bold;
}
.button-group {
display: flex;
gap: 15px;
justify-content: center;
margin-top: 20px;
}
.button-group button {
font-size: 18px;
padding: 15px 30px;
background: #3A358E;
color: white;
border: none;
border-radius: 5px;
cursor: pointer;
transition: all 0.3s ease;
}
.button-group button:hover {
background: #5c6bc0;
transform: translateY(-2px);
}
.report-tables-wrapper {
display: flex;
gap: 20px;
margin-bottom: 30px;
}
.report-tables-wrapper .expense-section {
flex: 1;
min-width: 0;
}
.print-title {
display: none;
text-align: center;
font-size: 18px;
font-weight: bold;
color: #3A358E;
margin-bottom: 10px;
}
@media print {
.sidebar,
.button-group,
button {
display: none !important;
}
body {
background: white;
padding: 0;
}
.main-wrapper {
margin: 0;
box-shadow: none;
}
.main-content {
padding: 0;
}
.container {
box-shadow: none;
padding: 10px;
}
.print-title {
display: block !important;
}
.report-tables-wrapper {
display: flex !important;
gap: 10px !important;
}
table {
page-break-inside: auto;
}
tr {
page-break-inside: avoid;
page-break-after: auto;
}
.expense-table th.normal {
min-width: auto !important;
width: auto !important;
font-size: 16px !important;
padding: 6px 4px !important;
white-space: nowrap !important;
font-weight: bold !important;
}
.expense-table td {
min-width: auto !important;
width: auto !important;
font-size: 15px !important;
padding: 6px 4px !important;
white-space: nowrap !important;
font-weight: bold !important;
}
.expense-table table {
min-width: 0 !important;
width: 100% !important;
table-layout: fixed !important;
}
.section-title {
font-size: 14px !important;
padding: 8px !important;
}
.header h1 {
font-size: 20px !important;
}
.header h2 {
display: none !important;
}
.expense-table table {
min-width: 0 !important;
width: 100% !important;
table-layout: fixed !important;
}
/* --- Column Width Adjustments --- */
.expense-table th:nth-child(1), .expense-table td:nth-child(1) { width: 8% !important; } /* ‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï ‡¶®‡¶Ç */
.expense-table th:nth-child(2), .expense-table td:nth-child(2) { width: 13% !important; } /* ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ */
.expense-table th:nth-child(3), .expense-table td:nth-child(3) { width: 18% !important; } /* ‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ */
.expense-table th:nth-child(4), .expense-table td:nth-child(4) { width: 14% !important; } /* ‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡ßã‡¶° */
.expense-table th:nth-child(5), .expense-table td:nth-child(5) { width: 34% !important; } /* ‡¶¨‡¶ø‡¶≤ ‡¶®‡¶Ç */
.expense-table th:nth-child(6), .expense-table td:nth-child(6) { width: 8% !important; } /* ‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶®‡¶Ç */
.expense-table th:nth-child(7), .expense-table td:nth-child(7) { width: 12% !important; } /* ‡ßß‡¶Æ ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® */
.expense-table th:nth-child(8), .expense-table td:nth-child(8) { width: 12% !important; } /* ‡¶®‡¶¨‡¶æ‡ßü‡¶® ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® */
.expense-table th:nth-child(9), .expense-table td:nth-child(9) { width: 12% !important; } /* ‡¶Æ‡ßã‡¶ü */
/* --- End Column Width Adjustments --- */
.header .field-group.date-range label {
margin-left: 0px !important;
margin-right: 0px !important;
}
}
</style>
</head>
<body>
<div class="main-wrapper">
<nav class="sidebar">
<a class="sidebar-header" href="data entry.html" style="text-decoration: none; display: block; color: white;">
üè† ‡¶π‡ßã‡¶Æ
</a>
<ul>
<li><a href="data entry.html">üìù ‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</a></li>
<li><a href="commission_calculation.html">üßÆ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® ‡¶ó‡¶£‡¶®‡¶æ</a></li>
<li><a href="pettycash-statement.html">üí∞ ‡¶™‡ßá‡¶ü‡¶ø‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</a></li>
<li><a href="Commission Statement.html">üìä ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</a></li>
<li><a href="Manpower List (Editable).html">üë• ‡¶ú‡¶®‡¶¨‡¶≤ ‡¶ì ‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶ñ‡¶æ‡¶§</a></li>
<li><a href="archive.html" class="active">üì¶ ‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠</a></li>
<li><a href="data management.html">‚öôÔ∏è ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</a></li>
<li><a href="edit-archive.html">‚úèÔ∏è ‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</a></li>
</ul>
</nav><div class="main-content">
<div class="container">
<div class="header">
<img src="Logo.png" alt="‡¶ú‡ßÄ‡¶¨‡¶® ‡¶¨‡ßÄ‡¶Æ‡¶æ ‡¶ï‡¶∞‡¶™‡ßã‡¶∞‡ßá‡¶∂‡¶® Logo" style="max-width: 400px; height: auto; margin-bottom: 10px;">
<h2>‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
<div class="info-line">
<div class="field-group">
<label>‡¶Ö‡¶´‡¶ø‡¶∏‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
<input type="text" id="office-name" style="width: 250px;">
</div>
<div class="field-group date-range center-group">
<label>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
<input type="text" id="start-date" placeholder="dd/mm/yy" style="width: 100px;">
<label>‡¶π‡¶§‡ßá:</label>
<input type="text" id="end-date" placeholder="dd/mm/yy" style="width: 100px;">
</div>
<div class="field-group">
<label>‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶ï‡ßã‡¶°:</label>
<input type="text" id="office-code" style="width: 150px;">
</div>
</div>
</div>
<div class="main-sections-wrapper">
<div class="expense-section">
<div class="expense-table">
<div class="section-title"></div>
<table>
<thead>
<tr>
<th class="normal">‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï ‡¶®‡¶Ç <button onclick="generateSerialNumbers()" style="font-size: 10px; padding: 2px 4px; background: #fff; color: #3A358E; border: 1px solid #3A358E; border-radius: 3px; cursor: pointer;">‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï ‡¶®‡¶Ç ‡¶§‡ßà‡¶∞‡ßÄ ‡¶ï‡¶∞‡ßÅ‡¶®</button></th>
<th class="normal">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
<th class="normal">‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
<th class="normal">‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡ßã‡¶°</th>
<th class="normal">‡¶¨‡¶ø‡¶≤ ‡¶®‡¶Ç</th>
<th class="normal">‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶®‡¶Ç <button onclick="generateVoucherNumbers()" style="font-size: 10px; padding: 2px 4px; background: #fff; color: #3A358E; border: 1px solid #3A358E; border-radius: 3px; cursor: pointer;">‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶§‡ßà‡¶∞‡ßÄ ‡¶ï‡¶∞‡ßÅ‡¶®</button></th>
<th>‡ßß‡¶Æ ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®</th>
<th>‡¶®‡¶¨‡¶æ‡¶Ø‡¶º‡¶® ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®</th>
<th>‡¶Æ‡ßã‡¶ü</th>
</tr>
</thead>
<tbody id="expense-body">
</tbody>
</table>
</div>
</div>
</div>
<div class="button-group">
<button onclick="generateReport()">Generate Statement</button>
</div>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
function toBengaliNumerals(str) {
    if (str === null || str === undefined) str = '';
    const bengaliDigits = ['‡ß¶', '‡ßß', '‡ß®', '‡ß©', '‡ß™', '‡ß´', '‡ß¨', '‡ß≠', '‡ßÆ', '‡ßØ'];
    return String(str).replace(/[0-9]/g, (digit) => {
        return bengaliDigits[parseInt(digit)];
    });
}

function toLatinNumerals(str) {
    if (str === null || str === undefined) str = '';
    const latinDigits = {'‡ß¶':'0', '‡ßß':'1', '‡ß®':'2', '‡ß©':'3', '‡ß™':'4', '‡ß´':'5', '‡ß¨':'6', '‡ß≠':'7', '‡ßÆ':'8', '‡ßØ':'9', '.': '.'};
    return String(str).replace(/[‡ß¶-‡ßØ\.]/g, (digit) => {
        return latinDigits[digit] || digit;
    });
}

function formatDateToDDMMYY(isoDate) {
    const d = new Date(isoDate);
    if (isNaN(d.getTime())) return toBengaliNumerals(isoDate);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = String(d.getFullYear() % 100).padStart(2, '0');
    
    const latinDate = `${day}/${month}/${year}`;
    return toBengaliNumerals(latinDate);
}

function parseDisplayDate(str) {
    str = toLatinNumerals(str); 
    str = str.trim().replace(/\s/g, '');
    const parts = str.split('/');
    if (parts.length !== 3) return null;
    let day = parts[0].padStart(2, '0');
    let month = parts[1].padStart(2, '0');
    let year = parts[2];
    if (year.length === 2) year = '20' + year;
    const iso = `${year}-${month}-${day}`;
    if (isNaN(new Date(iso).getTime())) return null;
    return iso;
}

function loadCommissionStatement() {
    const expenses = JSON.parse(localStorage.getItem('pettyCashExpenses') || '[]');
    const expenseTableBody = document.getElementById('expense-body');
    const expenseTable = expenseTableBody.closest('table');
    if (!expenseTable) return;
    const expenseTableHeaders = Array.from(expenseTable.querySelector('thead tr').children);
    expenseTableBody.innerHTML = '';
    const headerMap = {};
    expenseTableHeaders.forEach((th, index) => {
        let headerText = th.textContent.replace(/‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï ‡¶®‡¶Ç ‡¶§‡ßà‡¶∞‡ßÄ ‡¶ï‡¶∞‡ßÅ‡¶®|‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶§‡ßà‡¶∞‡ßÄ ‡¶ï‡¶∞‡ßÅ‡¶®/g, '').trim();
        headerMap[headerText] = index;
    });

    const startDateStr = document.getElementById('start-date').value;
    const endDateStr = document.getElementById('end-date').value;
    const startISO = parseDisplayDate(startDateStr) || '1900-01-01';
    const endISO = parseDisplayDate(endDateStr) || '9999-12-31';

    const filteredExpenses = expenses.filter(entry => 
        entry.date >= startISO && 
        entry.date <= endISO && 
        ['‡ßß‡¶Æ ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®', '‡¶®‡¶¨‡¶æ‡¶Ø‡¶º‡¶® ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®'].includes(entry.expenseColumn)
    );
    
    // --- START: Grouping Logic (Session-Based) ---
    const groupedCommissions = {};
    filteredExpenses.forEach(entry => {
        
        let groupKey;
        const isCommission = entry.expenseColumn === '‡ßß‡¶Æ ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®' || entry.expenseColumn === '‡¶®‡¶¨‡¶æ‡¶Ø‡¶º‡¶® ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®';
        
        // --- This is the key logic from pettycash-statement.html ---
        if (isCommission && entry.sessionId) {
            // Group commissions ONLY if they share a sessionId
            groupKey = `commission_session_${entry.sessionId}`;
        } else {
            // Fallback for older entries without a sessionID
            // Group by date, code, and name as a fallback
            const date = entry.date;
            const code = (entry.manpowerCode || 'no-code').trim();
            const name = (entry.manpowerName || 'no-name').trim();
            // This fallback also needs to be unique, so we'll use the ID
            groupKey = `unique_${entry.id}`;
        }
        // --- End of key logic ---

        if (!groupedCommissions[groupKey]) {
            groupedCommissions[groupKey] = {
                date: entry.date, // Use the date from the first entry in the session
                manpowerName: (entry.manpowerName || 'no-name').trim(),
                manpowerCode: (entry.manpowerCode || 'no-code').trim(),
                voucherNo: entry.voucherNo, // Take the voucher from the first entry we find
                firstYearComm: 0,
                renewalComm: 0,
                billNos: [] // Array to hold all bill numbers
            };
        }
        
        // Add bill number to the array if it's not already there
        const billNo = (entry.billNo || '').trim();
        if (billNo && !groupedCommissions[groupKey].billNos.includes(billNo)) {
            groupedCommissions[groupKey].billNos.push(billNo);
        }
        
        const amount = parseFloat(entry.amount) || 0;
        if (entry.expenseColumn === '‡ßß‡¶Æ ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®') {
            groupedCommissions[groupKey].firstYearComm += amount;
        } else if (entry.expenseColumn === '‡¶®‡¶¨‡¶æ‡¶Ø‡¶º‡¶® ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®') {
            groupedCommissions[groupKey].renewalComm += amount;
        }
    });
    // --- END: Grouping Logic ---


    let grandTotal = 0;
    let firstYearTotal = 0;
    let renewalTotal = 0;
    
    // --- START: Iterate over Groups, not individual entries ---
    // Use Object.entries to get the groupKey
    Object.entries(groupedCommissions).forEach(([groupKey, group]) => {
        const tr = document.createElement('tr');
        // Store the groupKey on the row element for saving later
        tr.dataset.groupKey = groupKey; 
        
        const numColumns = expenseTableHeaders.length;
        const rowCells = Array(numColumns).fill('<td class="static-cell">‡ß¶</td>'); // Default to 0
        
        const totalComm = group.firstYearComm + group.renewalComm;
        grandTotal += totalComm;
        firstYearTotal += group.firstYearComm;
        renewalTotal += group.renewalComm;

        rowCells[headerMap['‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï ‡¶®‡¶Ç']] = '<td><input type="text"></td>';
        rowCells[headerMap['‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶®‡¶Ç']] = `<td><input type="text" value="${toBengaliNumerals(group.voucherNo || '')}"></td>`;
        
        rowCells[headerMap['‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ']] = `<td class="static-cell">${formatDateToDDMMYY(group.date)}</td>`;
        rowCells[headerMap['‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ']] = `<td class="static-cell">${group.manpowerName || ''}</td>`;
        rowCells[headerMap['‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡ßã‡¶°']] = `<td class="static-cell">${toBengaliNumerals(group.manpowerCode || '')}</td>`;
        
        // Join all collected bill numbers
        const allBills = group.billNos.join(' / ');
        rowCells[headerMap['‡¶¨‡¶ø‡¶≤ ‡¶®‡¶Ç']] = `<td class="static-cell">${toBengaliNumerals(allBills)}</td>`;
        
        // Fill commission columns
        rowCells[headerMap['‡ßß‡¶Æ ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®']] = `<td class="static-cell">${toBengaliNumerals(group.firstYearComm.toFixed(2))}</td>`;
        rowCells[headerMap['‡¶®‡¶¨‡¶æ‡¶Ø‡¶º‡¶® ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®']] = `<td class="static-cell">${toBengaliNumerals(group.renewalComm.toFixed(2))}</td>`;
        rowCells[headerMap['‡¶Æ‡ßã‡¶ü']] = `<td class="static-cell">${toBengaliNumerals(totalComm.toFixed(2))}</td>`;
        
        tr.innerHTML = rowCells.join('');
        expenseTableBody.appendChild(tr);
    });
    // --- END: Iteration Logic ---
    
    let tfoot = expenseTable.querySelector('tfoot');
    if (!tfoot) {
        tfoot = document.createElement('tfoot');
        expenseTable.appendChild(tfoot);
    }

    const totalColsForColspan = expenseTableHeaders.length - 3; // Colspan for all columns except the 3 totals

    tfoot.innerHTML = `<tr>
        <td colspan="${totalColsForColspan}" style="text-align:right; font-weight:bold; border: 1px solid #3A358E;">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü</td>
        <td class="static-cell" style="border: 1px solid #3A358E;">${toBengaliNumerals(firstYearTotal.toFixed(2))}</td>
        <td class="static-cell" style="border: 1px solid #3A358E;">${toBengaliNumerals(renewalTotal.toFixed(2))}</td>
        <td class="static-cell" style="border: 1px solid #3A358E;">${toBengaliNumerals(grandTotal.toFixed(2))}</td>
    </tr>`;
    
    return filteredExpenses; // Still return original filtered for other potential uses
}
function generateSerialNumbers() {
    const tbody = document.getElementById('expense-body');
    const rows = tbody.querySelectorAll('tr');
    if (rows.length === 0) return;
    const firstInput = rows[0].children[0].querySelector('input');
    
    let startNum = parseInt(toLatinNumerals(firstInput.value), 10);
    if (isNaN(startNum) || startNum < 1) {
        startNum = 1;
    }
    
    firstInput.value = toBengaliNumerals(startNum);
    
    for (let i = 1; i < rows.length; i++) {
        const input = rows[i].children[0].querySelector('input');
        if (input) {
            input.value = toBengaliNumerals(++startNum);
        }
    }
}

// ***FIX: UPDATED FUNCTION***
function generateVoucherNumbers() {
    const tbody = document.getElementById('expense-body');
    const rows = tbody.querySelectorAll('tr');
    if (rows.length === 0) return;
    
    // Find the first row that has a voucher input
    let firstInput = null;
    let firstRowIndex = -1;
    for(let i = 0; i < rows.length; i++) {
        const input = rows[i].children[5].querySelector('input'); // Column index 5
        if(input) {
            firstInput = input;
            firstRowIndex = i;
            break;
        }
    }

    if(!firstInput) return; // No inputs found
    
    let startNum = parseInt(toLatinNumerals(firstInput.value), 10);
    
    if (isNaN(startNum) || startNum < 1) {
        // If first input is empty, find the max voucher number from ALL expenses
        const expenses = JSON.parse(localStorage.getItem('pettyCashExpenses') || '[]');
        let maxVoucher = 0;
        expenses.forEach(e => { 
          const v = parseInt(e.voucherNo, 10); 
          if (!isNaN(v) && v > maxVoucher) maxVoucher = v; 
        });
        startNum = maxVoucher + 1;
    }
    
    // Apply the first number
    firstInput.value = toBengaliNumerals(startNum);
    
    // Apply subsequent numbers
    for (let i = firstRowIndex + 1; i < rows.length; i++) {
        const input = rows[i].children[5].querySelector('input'); // Column index 5
        if (input) {
            input.value = toBengaliNumerals(++startNum);
        }
    }
    saveExpenseExtras(); // Save the new numbers
}

function saveExpenseExtras() {
    const expenses = JSON.parse(localStorage.getItem('pettyCashExpenses') || '[]');
    const rows = document.getElementById('expense-body').querySelectorAll('tr');
    
    // Create a map to store the new values for each group key
    const updatedGroupData = {};
    
    rows.forEach((row) => {
        // --- START: Updated Save Logic ---
        const groupKey = row.dataset.groupKey;
        if (!groupKey) return; // Skip if row has no group key

        const voucherInput = row.children[5].querySelector('input'); // Column index 5
        if (!voucherInput) return; // Skip if no voucher input
        
        const voucher = toLatinNumerals(voucherInput.value.trim());
        
        updatedGroupData[groupKey] = voucher;
    });

    // Iterate through the master expenses list ONCE
    expenses.forEach(entry => {
        if (!['‡ßß‡¶Æ ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®', '‡¶®‡¶¨‡¶æ‡¶Ø‡¶º‡¶® ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®'].includes(entry.expenseColumn)) {
            return; // Only modify commission entries from this page
        }

        let key;
        const isCommission = true; 
        
        if (isCommission && entry.sessionId) {
            key = `commission_session_${entry.sessionId}`;
        } else {
            // Fallback logic must match load logic exactly
            key = `unique_${entry.id}`;
        }
        
        // If this entry's group key is in our map, update the entry
        if (updatedGroupData[key] !== undefined) {
            entry.voucherNo = updatedGroupData[key];
        }
    });
    
    localStorage.setItem('pettyCashExpenses', JSON.stringify(expenses));
}

function saveToArchive() {
    const archives = JSON.parse(localStorage.getItem('commissionArchives') || '[]');

    const officeName = document.getElementById('office-name').value;
    const officeCode = document.getElementById('office-code').value; 
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;

    let month = "";
    let year = "";
    if (startDate && startDate.split('/').length === 3) {
        const isoDate = parseDisplayDate(startDate);
        const d = new Date(isoDate);
        
        const monthIndex = d.getMonth();
        year = String(d.getFullYear());
        
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        if (monthIndex >= 0 && monthIndex < 12) {
             month = monthNames[monthIndex];
        }
    } else {
        month = "Unknown";
        year = new Date().getFullYear().toString();
    }

    const entries = [];
    const rows = document.getElementById('expense-body').querySelectorAll('tr');
    let grandTotalCommission = 0;

    rows.forEach(row => {
        const cells = row.children;
        const serialInput = cells[0].querySelector('input');
        const voucherInput = cells[5].querySelector('input');

        // Ensure inputs exist before trying to read them
        if (!serialInput || !voucherInput) return;

        const serial = toLatinNumerals(serialInput.value.trim());
        const date = toLatinNumerals(cells[1].textContent.trim());
        const agentName = cells[2].textContent.trim();
        const agentCode = toLatinNumerals(cells[3].textContent.trim());
        const billNo = toLatinNumerals(cells[4].textContent.trim()); // This will now save the combined bill string
        const voucherNo = toLatinNumerals(voucherInput.value.trim());
        const firstYearComm = toLatinNumerals(cells[6].textContent.trim());
        const renewalComm = toLatinNumerals(cells[7].textContent.trim());
        const totalComm = toLatinNumerals(cells[8].textContent.trim());
        
        grandTotalCommission += parseFloat(totalComm) || 0;

        entries.push({
            serial: serial,
            date: date,
            agentName: agentName,
            agentCode: agentCode,
            billNo: billNo,
            voucherNo: voucherNo,
            firstYearComm: firstYearComm,
            renewalComm: renewalComm,
            totalComm: totalComm
        });
    });

    const tfoot = document.querySelector('#expense-body').closest('table').querySelector('tfoot tr');
    if (tfoot && tfoot.children.length > 0) {
         grandTotalCommission = parseFloat(toLatinNumerals(tfoot.children[tfoot.children.length - 1].textContent.trim())) || grandTotalCommission;
    }

    const archiveName = `‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ${startDate} - ${endDate}`;

    const newArchive = {
        id: Date.now(),
        createdAt: new Date().toISOString(),
        name: archiveName,
        data: { 
            officeName: officeName,
            officeCode: officeCode,
            startDate: startDate,
            endDate: endDate,
            month: month,
            year: year,
            entries: entries, 
            totals: {
                totalCommission: grandTotalCommission.toFixed(2)
            }
        }
    };
    
    archives.push(newArchive);
    localStorage.setItem('commissionArchives', JSON.stringify(archives));
    alert('‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
}

document.addEventListener('DOMContentLoaded', function() {
document.getElementById('office-name').value = localStorage.getItem('officeName') || '';
document.getElementById('start-date').value = localStorage.getItem('startDate') || '';
document.getElementById('end-date').value = localStorage.getItem('endDate') || '';
document.getElementById('office-code').value = localStorage.getItem('officeCode') || '';
document.getElementById('office-name').addEventListener('change', () => {
localStorage.setItem('officeName', document.getElementById('office-name').value);
});
document.getElementById('start-date').addEventListener('change', () => {
localStorage.setItem('startDate', document.getElementById('start-date').value);
loadCommissionStatement();
});
document.getElementById('end-date').addEventListener('change', () => {
localStorage.setItem('endDate', document.getElementById('end-date').value);
loadCommissionStatement();
});
document.getElementById('office-code').addEventListener('change', () => {
localStorage.setItem('officeCode', document.getElementById('office-code').value);
});
flatpickr("#start-date", {
dateFormat: "d/m/y",
allowInput: true
});
flatpickr("#end-date", {
dateFormat: "d/m/y",
allowInput: true
});
loadCommissionStatement();
document.getElementById('expense-body').addEventListener('input', (e) => {
if (e.target.type === 'text') {
saveExpenseExtras();
}
});
});

function generateReport() {
saveToArchive(); 
let reportWindow = window.open('', '_blank');
let reportDoc = reportWindow.document;
reportDoc.open();
reportDoc.write('<!DOCTYPE html><html lang="bn">');
let headClone = document.head.cloneNode(true);
headClone.querySelector('title')?.remove();
reportDoc.write(headClone.outerHTML);
reportDoc.write('<style>');
reportDoc.write(`
@page {
size: legal landscape;
margin: 0.25in;
}
* {
font-family: 'Kalpurush', 'SolaimanLipi', Arial, sans-serif !important;
}
body {
counter-reset: page 1;
margin: 0;
padding: 0;
display: flex;
justify-content: center;
align-items: flex-start;
background: white;
}
.main-wrapper {
width: 100%;
max-width: 100%;
display: flex;
justify-content: center;
box-shadow: none;
}
.main-content {
width: 100%;
display: flex;
justify-content: center;
padding: 10px;
}
.container {
width: fit-content;
margin: 0 auto;
box-shadow: none;
padding: 5px;
}
@page {
@top-left { content: none; }
@top-center { content: none; }
@top-right { content: none; }
@bottom-left { content: none; }
@bottom-center { content: none; }
@bottom-right { content: none; }
}
@media print {
body { 
}
.expense-table th.normal {
min-width: auto !important;
width: auto !important;
font-size: 16px !important;
padding: 6px 4px !important;
white-space: nowrap !important;
font-weight: bold !important;
}
.expense-table td {
min-width: auto !important;
width: auto !important;
font-size: 15px !important;
padding: 6px 4px !important;
white-space: nowrap !important;
font-weight: bold !important;
}
.expense-table table {
min-width: 0 !important;
width: 100% !important;
table-layout: fixed !important;
margin: 0 auto;
}
.section-title {
font-size: 18px !important;
padding: 8px !important;
}
.header h1 { 
font-size: 20px !important; 
}
.header h2 { 
display: none !important; 
}
.header img {
max-width: 300px !important;
}
.container { 
padding: 5px !important; 
}
.print-title { 
display: block !important;
font-size: 18px !important;
text-align: center;
margin-bottom: 10px;
}
.report-tables-wrapper {
display: flex !important;
gap: 10px !important;
justify-content: center;
}
.expense-section { 
flex: 1 !important; 
}
table { 
page-break-inside: auto;
border-collapse: collapse !important;
margin: 0 auto;
}
tr {
page-break-inside: avoid;
page-break-after: auto;
}
th, td {
border: 1px solid #3A358E !important;
}
tfoot td {
font-size: 15px !important;
padding: 6px 4px !important;
font-weight: bold !important;
}
.sidebar {
display: none !important;
}
.button-group {
display: none !important;
}
.expense-table table {
table-layout: fixed !important;
width: 100% !important;
}
/* --- Column Width Adjustments --- */
.expense-table th:nth-child(1), .expense-table td:nth-child(1) { width: 8% !important; } /* ‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï ‡¶®‡¶Ç narrower */
.expense-table th:nth-child(2), .expense-table td:nth-child(2) { width: 13% !important; } /* ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ */
.expense-table th:nth-child(3), .expense-table td:nth-child(3) { width: 18% !important; } /* ‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ wider */
.expense-table th:nth-child(4), .expense-table td:nth-child(4) { width: 14% !important; } /* ‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡ßã‡¶° */
.expense-table th:nth-child(5), .expense-table td:nth-child(5) { width: 34% !important; } /* ‡¶¨‡¶ø‡¶≤ ‡¶®‡¶Ç wider */
.expense-table th:nth-child(6), .expense-table td:nth-child(6) { width: 8% !important; } /* ‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶®‡¶Ç narrower */
.expense-table th:nth-child(7), .expense-table td:nth-child(7) { width: 15% !important; } /* ‡ßß‡¶Æ ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® */
.expense-table th:nth-child(8), .expense-table td:nth-child(8) { width: 15% !important; } /* ‡¶®‡¶¨‡¶æ‡¶Ø‡¶º‡¶® ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® */
.expense-table th:nth-child(9), .expense-table td:nth-child(9) { width: 15% !important; } /* ‡¶Æ‡ßã‡¶ü */
/* --- End Column Width Adjustments --- */
.header .field-group.date-range label {
margin-left: 0px !important;
margin-right: 0px !important;
}
}
`);
reportDoc.write('</style>');
let bodyClone = document.body.cloneNode(true);
bodyClone.querySelector('script')?.remove();
let containerClone = bodyClone.querySelector('.container');
containerClone.querySelectorAll('input').forEach(input => {
let span = reportDoc.createElement('span');
span.textContent = toBengaliNumerals(input.value || ''); 
span.style.display = 'inline-block';
span.style.width = 'auto';
span.style.textAlign = 'center';
input.parentNode.replaceChild(span, input);
});
containerClone.querySelectorAll('button').forEach(btn => btn.remove());
let mainWrapper = containerClone.querySelector('.main-sections-wrapper');
mainWrapper.classList.add('report-tables-wrapper');
let expenseTable = containerClone.querySelector('.expense-table table');
let theadRow = expenseTable.querySelector('thead tr');
let ths = Array.from(theadRow.children);
let tbodyRows = Array.from(expenseTable.querySelector('#expense-body').children);
let tfootRow = expenseTable.querySelector('tfoot tr');
let numColumns = ths.length;

// --- START: Modified Column Hiding Logic ---
let firstYearTotal = 0;
let renewalTotal = 0;

// Check if *any* row has data
for (let row of tbodyRows) {
    let fyCell = row.children[6];
    let rnCell = row.children[7];
    if (fyCell && (parseFloat(toLatinNumerals(fyCell.textContent.trim())) || 0) > 0) {
        firstYearTotal = 1; // Mark as having data
    }
    if (rnCell && (parseFloat(toLatinNumerals(rnCell.textContent.trim())) || 0) > 0) {
        renewalTotal = 1; // Mark as having data
    }
}


let keepColumns = [0, 1, 2, 3, 4, 5, 8]; // Keep basic columns and Total
if (firstYearTotal > 0) {
    keepColumns.push(6); // Keep 1st Year
}
if (renewalTotal > 0) {
    keepColumns.push(7); // Keep Renewal
}

keepColumns.sort((a,b) => a - b); 

let removeColumns = [];
for (let i = 0; i < numColumns; i++) {
    if (!keepColumns.includes(i)) removeColumns.push(i);
}
removeColumns.sort((a,b)=>b-a); // Remove from end to not mess up indices
// --- END: Modified Column Hiding Logic ---


// Remove columns from header
for (let idx of removeColumns) {
theadRow.children[idx].remove();
}

// Remove columns from body rows
for (let row of tbodyRows) {
for (let idx of removeColumns) {
row.children[idx].remove();
}
}

// Handle footer
if (tfootRow) {
    let tfootCells = Array.from(tfootRow.children); // 0=colspan, 1=FY, 2=RN, 3=Total
    
    if (removeColumns.includes(7)) {
        if(tfootCells[2]) tfootCells[2].remove(); // Remove Renewal
    }
    if (removeColumns.includes(6)) {
        if(tfootCells[1]) tfootCells[1].remove(); // Remove 1st Year
    }
    
    // Now update colspan
    const remainingColumns = keepColumns.length;
    let numTotalColumns = 0;
    for(let i = 0; i < tfootRow.children.length; i++) {
        if(!tfootRow.children[i].hasAttribute('colspan')) {
            numTotalColumns++;
        }
    }
    
    const colspanValue = remainingColumns - numTotalColumns;
    
    const firstCell = tfootRow.querySelector('td:first-child');
    if (firstCell) {
        firstCell.setAttribute('colspan', colspanValue);
    }
}

// New additions for generated report page
containerClone.querySelector('.header h2').style.display = 'none';
let printTitle = reportDoc.createElement('div');
printTitle.className = 'print-title';
printTitle.innerText = '‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü';
let infoLine = containerClone.querySelector('.info-line');
containerClone.querySelector('.header').insertBefore(printTitle, infoLine);

let buttonGroup = reportDoc.createElement('div');
buttonGroup.className = 'button-group';
buttonGroup.innerHTML = `<button onclick="window.print()" style="font-size: 18px; padding: 15px 30px; background: #3A358E; color: white; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='#5c6bc0'; this.style.transform = 'translateY(-2px)';" onmouseout="this.style.background='#3A358E'; this.style.transform = 'none';">Print</button>`;
containerClone.appendChild(buttonGroup);

reportDoc.write(bodyClone.outerHTML);
reportDoc.close();
}

function printReport() {
saveExpenseExtras();
let reportWindow = window.open('', '_blank');
let reportDoc = reportWindow.document;
reportDoc.open();
reportDoc.write('<!DOCTYPE html><html lang="bn">');
let headClone = document.head.cloneNode(true);
headClone.querySelector('title')?.remove();
let printStyle = reportDoc.createElement('style');
printStyle.textContent = `
@page {
size: legal landscape;
margin: 0.25in;
}
* {
font-family: 'Kalpurush', 'SolaimanLipi', Arial, sans-serif !important;
}
body {
counter-reset: page 1;
margin: 0;
padding: 0;
display: flex;
justify-content: center;
align-items: flex-start;
}
.main-wrapper {
width: 100%;
max-width: 100%;
display: flex;
justify-content: center;
}
.main-content {
width: 100%;
display: flex;
justify-content: center;
padding: 10px;
}
.container {
width: fit-content;
margin: 0 auto;
}
@page {
@top-left { content: none; }
@top-center { content: none; }
@top-right { content: none; }
@bottom-left { content: none; }
@bottom-center { content: none; }
@bottom-right { content: none; }
}
@media print {
body { 
}
.expense-table th.normal {
min-width: auto !important;
width: auto !important;
font-size: 16px !important;
padding: 6px 4px !important;
white-space: nowrap !important;
font-weight: bold !important;
}
.expense-table td {
min-width: auto !important;
width: auto !important;
font-size: 15px !important;
padding: 6px 4px !important;
white-space: nowrap !important;
font-weight: bold !important;
}
.expense-table table {
min-width: 0 !important;
width: 100% !important;
table-layout: fixed !important;
margin: 0 auto;
}
.section-title {
font-size: 18px !important;
padding: 8px !important;
}
.header h1 { 
font-size: 20px !important; 
}
.header h2 { 
display: none !important; 
}
.header img {
max-width: 300px !important;
}
.container { 
padding: 5px !important; 
}
.print-title { 
display: block !important;
font-size: 18px !important;
text-align: center;
margin-bottom: 10px;
}
.report-tables-wrapper {
display: flex !important;
gap: 10px !important;
justify-content: center;
}
.expense-section { 
flex: 1 !important; 
}
table { 
page-break-inside: auto;
border-collapse: collapse !important;
margin: 0 auto;
}
tr {
page-break-inside: avoid;
page-break-after: auto;
}
th, td {
border: 1px solid #3A358E !important;
}
tfoot td {
font-size: 15px !important;
padding: 6px 4px !important;
font-weight: bold !important;
}
.sidebar {
display: none !important;
}
.button-group {
display: none !important;
}
.expense-table table {
table-layout: fixed !important;
width: 100% !important;
}

/* --- Column Width Adjustments --- */
.expense-table th:nth-child(1), .expense-table td:nth-child(1) { width: 8% !important; } /* ‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï ‡¶®‡¶Ç */
.expense-table th:nth-child(2), .expense-table td:nth-child(2) { width: 13% !important; } /* ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ */
.expense-table th:nth-child(3), .expense-table td:nth-child(3) { width: 18% !important; } /* ‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ */
.expense-table th:nth-child(4), .expense-table td:nth-child(4) { width: 14% !important; } /* ‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡ßã‡¶° */
.expense-table th:nth-child(5), .expense-table td:nth-child(5) { width: 34% !important; } /* ‡¶¨‡¶ø‡¶≤ ‡¶®‡¶Ç */
.expense-table th:nth-child(6), .expense-table td:nth-child(6) { width: 8% !important; } /* ‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶®‡¶Ç */
.expense-table th:nth-child(7), .expense-table td:nth-child(7) { width: 12% !important; } /* ‡ßß‡¶Æ ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® */
.expense-table th:nth-child(8), .expense-table td:nth-child(8) { width: 12% !important; } /* ‡¶®‡¶¨‡¶æ‡¶Ø‡¶º‡¶® ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® */
.expense-table th:nth-child(9), .expense-table td:nth-child(9) { width: 12% !important; } /* ‡¶Æ‡ßã‡¶ü */
/* --- End Column Width Adjustments --- */
.header .field-group.date-range label {
margin-left: 0px !important;
margin-right: 0px !important;
}
}
`;
headClone.appendChild(printStyle);
reportDoc.write(headClone.outerHTML);
let bodyClone = document.body.cloneNode(true);
bodyClone.querySelector('script')?.remove();
let containerClone = bodyClone.querySelector('.container');

containerClone.querySelectorAll('.static-cell').forEach(cell => {
    const text = cell.textContent.trim();
    if (text.match(/\d{2}\/\d{2}\/\d{2,4}/)) {
        cell.textContent = toBengaliNumerals(text);
    }
});

containerClone.querySelectorAll('input').forEach(input => {
let span = reportDoc.createElement('span');
span.textContent = toBengaliNumerals(input.value || '');
span.style.display = 'inline-block';
span.style.width = 'auto';
span.style.textAlign = 'center';
input.parentNode.replaceChild(span, input);
});

containerClone.querySelectorAll('button').forEach(btn => btn.remove());
containerClone.querySelector('.header h2')?.remove();

let infoLine = containerClone.querySelector('.info-line');
let printTitle = reportDoc.createElement('div');
printTitle.className = 'print-title';
printTitle.textContent = '‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü';
infoLine.parentNode.insertBefore(printTitle, infoLine);

let mainWrapper = containerClone.querySelector('.main-sections-wrapper');
mainWrapper.classList.add('report-tables-wrapper');

let expenseTable = containerClone.querySelector('.expense-table table');
let theadRow = expenseTable.querySelector('thead tr');
let ths = Array.from(theadRow.children);
let tbodyRows = Array.from(expenseTable.querySelector('#expense-body').children);
let tfootRow = expenseTable.querySelector('tfoot tr');

let numColumns = ths.length;

// --- START: Modified Column Hiding Logic ---
let firstYearTotal = 0;
let renewalTotal = 0;

// Check if *any* row has data
for (let row of tbodyRows) {
    let fyCell = row.children[6];
    let rnCell = row.children[7];
    if (fyCell && (parseFloat(toLatinNumerals(fyCell.textContent.trim())) || 0) > 0) {
        firstYearTotal = 1; // Mark as having data
    }
    if (rnCell && (parseFloat(toLatinNumerals(rnCell.textContent.trim())) || 0) > 0) {
        renewalTotal = 1; // Mark as having data
    }
}


let keepColumns = [0, 1, 2, 3, 4, 5, 8]; // Keep basic columns and Total
if (firstYearTotal > 0) {
    keepColumns.push(6); // Keep 1st Year
}
if (renewalTotal > 0) {
    keepColumns.push(7); // Keep Renewal
}

keepColumns.sort((a,b) => a - b); 

let removeColumns = [];
for (let i = 0; i < numColumns; i++) {
    if (!keepColumns.includes(i)) removeColumns.push(i);
}
removeColumns.sort((a,b)=>b-a); // Remove from end to not mess up indices
// --- END: Modified Column Hiding Logic ---

for (let idx of removeColumns) {
theadRow.children[idx].remove();
}
for (let row of tbodyRows) {
for (let idx of removeColumns) {
if (row.children[idx]) row.children[idx].remove();
}
}
if (tfootRow) {
    let tfootCells = Array.from(tfootRow.children); // 0=colspan, 1=FY, 2=RN, 3=Total
    
    if (removeColumns.includes(7)) {
        if(tfootCells[2]) tfootCells[2].remove(); // Remove Renewal
    }
    if (removeColumns.includes(6)) {
        if(tfootCells[1]) tfootCells[1].remove(); // Remove 1st Year
    }
    
    // Now update colspan
    const remainingColumns = keepColumns.length;
    let numTotalColumns = 0;
    for(let i = 0; i < tfootRow.children.length; i++) {
        if(!tfootRow.children[i].hasAttribute('colspan')) {
            numTotalColumns++;
        }
    }
    
    const colspanValue = remainingColumns - numTotalColumns;
    
    const firstCell = tfootRow.querySelector('td:first-child');
    if (firstCell) {
        firstCell.setAttribute('colspan', colspanValue);
    }
}
let buttonGroup = reportDoc.createElement('div');
buttonGroup.className = 'button-group';
buttonGroup.innerHTML = `<button onclick="window.print()" style="font-size: 18px; padding: 15px 30px; background: #3A358E; color: white; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='#5c6bc0'; this.style.transform = 'translateY(-2px)';" onmouseout="this.style.background='#3A358E'; this.style.transform = 'none';">Print</button>`;
containerClone.appendChild(buttonGroup);

reportDoc.write(bodyClone.outerHTML);
reportDoc.close();
reportWindow.onload = function() {
reportWindow.focus();
reportWindow.print();
};
}</script>
</body>
</html>
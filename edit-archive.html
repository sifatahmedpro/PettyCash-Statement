<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
@font-face {
  font-family: 'Kalpurush';
  src: url('https://cdn.jsdelivr.net/gh/fonts-bangla/kalpurush@master/Kalpurush.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}
@font-face {
  font-family: 'SolaimanLipi';
  src: url('https://cdn.jsdelivr.net/gh/fonts-bangla/solaimanlipi@master/SolaimanLipi.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Kalpurush','SolaimanLipi', sans-serif;
  background: #f5f5ff;
  margin: 0;
}
input, button, select, textarea { font-family: 'Kalpurush','SolaimanLipi', sans-serif; }

.main-wrapper { max-width: 1400px; margin: 20px auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); background: white; display: flex; min-height: 90vh; }
.sidebar { width: 250px; background-color: #3A358E; color: white; padding: 20px 0; flex-shrink: 0; }
.sidebar-header {
    font-size: 22px;  /* Increased from 18px */
    font-weight: bold;
    text-align: center;
    margin-bottom: 25px;  /* Increased from 20px */
    padding-bottom: 15px;  /* Increased from 10px */
    padding-top: 10px;  /* Added vertical padding */
    padding-left: 10px;  /* Added horizontal padding */
    padding-right: 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}
.sidebar ul { list-style: none; padding: 0; margin: 0; }
.sidebar ul li a { display: block; padding: 12px 20px; color: white; text-decoration: none; transition: background-color 0.3s; }
.sidebar ul li a:hover, .sidebar ul li a.active { background-color: #2c286e; border-left: 5px solid #1abc9c; }

.main-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
.header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #3A358E; padding-bottom: 20px; display: flex; flex-direction: column; align-items: center; }
.header .logo { max-width: 350px; height: auto; margin-bottom: 10px; margin-top: 10px; }
.header h2 { font-size: 18px; color: #444; }

.tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #3A358E; }
.tab-btn { padding: 12px 24px; background: #ecf0f1; border: none; border-radius: 4px 4px 0 0; cursor: pointer; font-size: 16px; font-weight: bold; color: #333; transition: all 0.3s; }
.tab-btn.active { background: #3A358E; color: white; }
.tab-btn:hover { background: #2c286e; color: white; }

.tab-content { display: none; }
.tab-content.active { display: block; }

/* === NEW PICKER STYLES === */
#archive-picker-section { padding: 20px; background: #f9f9f9; border-radius: 8px; margin-bottom: 30px; }
#archive-picker-section h3 { margin-bottom: 15px; color: #3A358E; }
.picker-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; border: 1px solid #ccc; background: white; border-radius: 4px; }
.picker-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; }
.picker-item:last-child { border-bottom: none; }
.picker-item:nth-child(even) { background: #fdfdfd; }
.picker-item-info h4 { margin: 0; font-size: 16px; }
.picker-item-info p { margin: 5px 0 0; font-size: 13px; color: #555; }
.picker-item button { padding: 8px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
.picker-item button:hover { background: #2980b9; }
.no-archives { padding: 20px; text-align: center; color: #777; }
/* === END NEW PICKER STYLES === */


#editor-section { display: none; margin-top: 30px; border-top: 2px solid #3A358E; padding-top: 20px; }
#editor-section .container { padding: 20px; background: #f9f9f9; border: 1px solid #ccc; border-radius: 8px; }
.save-changes-btn { background: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; display: inline-block; margin: 20px 10px 20px 0; font-size: 16px; }
.export-pdf-btn { background: #e67e22; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; display: inline-block; margin-left: 10px; font-size: 16px; }
.cancel-btn { background: #f39c12; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; display: inline-block; margin-left: 10px; font-size: 16px; }
.cancel-btn:hover { background: #d35400; }

/* Editor styling (COPIED FROM archive.html) */
#editor-container .container { background: white; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-x: auto; position: relative; }
#editor-container .header { text-align: center; margin-bottom: 10px; border-bottom: 3px solid #3A358E; padding-bottom: 10px; }
#editor-container .header h2 { font-size: 18px; color: #3A358E; }
#editor-container .header .info-line { display: flex; justify-content: center; align-items: center; margin-top: 15px; padding: 0 10px; flex-wrap: wrap; }
#editor-container .header .field-group { display: flex; align-items: center; margin: 5px 0; }
#editor-container .header .field-group.center-group { justify-content: center; flex-grow: 1; text-align: center; }
#editor-container .header .field-group label { font-weight: bold; margin-right: 5px; white-space: nowrap; }
#editor-container .header .field-group input { padding: 5px; border: 1px solid #3A358E; border-radius: 4px; }

#editor-container .main-sections-wrapper { display: flex; gap: 20px; margin-bottom: 0; }
#editor-container .receipt-section { flex: 0 0 auto; width: 35%; margin-bottom: 0; }
#editor-container .expense-section { flex: 1; min-width: 0; margin-bottom: 0; }
#editor-container .section-title { background: #3A358E; color: white; padding: 12px; font-size: 16px; font-weight: bold; margin-bottom: 15px; }
#editor-container table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px; table-layout: fixed; }
#editor-container th, #editor-container td { border: 1px solid #3A358E; padding: 8px; text-align: center; font-weight: bold; }
#editor-container th { background: #3A358E; color: white; }
#editor-container .receipt-table th { font-size: 12px; }
#editor-container .expense-table { overflow-x: auto; }
#editor-container .expense-table table { width: auto; table-layout: fixed; min-width: 0; }
#editor-container .expense-table th { background: #3A358E; font-size: 11px; padding: 8px 5px; line-height: 1.3; white-space: normal; word-wrap: break-word; writing-mode: horizontal-tb; }
#editor-container .expense-table td { min-width: 35px; }

#editor-container .expense-table th.normal:nth-child(1), #editor-container .expense-table td:nth-child(1) { width: 80px; min-width: 80px; max-width: 80px; font-size: 12px; padding: 4px 2px; }
#editor-container .expense-table th.normal:nth-child(2), #editor-container .expense-table td:nth-child(2) { width: 120px; min-width: 120px; max-width: 120px; font-size: 11px; padding: 4px 2px; }
#editor-container .expense-table th.normal:nth-child(3), #editor-container .expense-table td:nth-child(3) { width: 15px; min-width: 15px; max-width: 15px; font-size: 11px; padding: 4px 2px; }
#editor-container .expense-table th.normal:nth-child(4), #editor-container .expense-table td:nth-child(4) { width: 60px; min-width: 60px; max-width: 60px; font-size: 11px; padding: 4px 2px; }
#editor-container .expense-table th.normal:nth-child(5), #editor-container .expense-table td:nth-child(5) { width: 50px; min-width: 50px; max-width: 50px; font-size: 11px; padding: 4px 2px; }
#editor-container .expense-table th.normal:nth-child(6), #editor-container .expense-table td:nth-child(6) { width: 60px; min-width: 60px; max-width: 60px; font-size: 11px; padding: 4px 2px; }

#editor-container .expense-table th:not(.normal),
#editor-container .expense-table td:not(:nth-child(1)):not(:nth-child(2)):not(:nth-child(3)):not(:nth-child(4)):not(:nth-child(5)):not(:nth-child(6)):not(:nth-last-child(2)):not(:last-child) {
  width: 45px; min-width: 45px; max-width: 45px; font-size: 10px; padding: 2px 1px; white-space: normal; word-wrap: break-word; line-height: 1.1;
}

#editor-container .expense-table th:nth-child(10), #editor-container .expense-table td:nth-child(10) { width: 60px; min-width: 60px; max-width: 60px; }
#editor-container .expense-table th:nth-last-child(2), #editor-container .expense-table td:nth-last-child(2) { width: 60px; min-width: 60px; max-width: 60px; font-size: 11px; padding: 4px 2px; }
#editor-container .expense-table th:last-child, #editor-container .expense-table td:last-child { width: 60px; min-width: 60px; max-width: 60px; font-size: 11px; padding: 4px 2px; background-color: #f0f0f0; }
#editor-container .expense-table th:last-child { background-color: #3A358E; }

#editor-container input[type="number"], #editor-container input[type="text"], #editor-container input[type="date"] {
  width: 100%; border: none; background: transparent; text-align: center; font-family: 'Kalpurush','SolaimanLipi', sans-serif !important; font-weight: bold !important;
}
#editor-container .editable-cell input { background: white; border: 1px dotted #3A358E; }
#editor-container .header .field-group input { background: white; border: 1px solid #3A358E; }

#editor-container .static-cell { padding: 8px; text-align: center; border: 1px solid #3A358E; font-family: 'Kalpurush','SolaimanLipi', sans-serif !important; font-weight: bold; }
#editor-container .summary-section { background: #ecf0f1; padding: 10px; border-radius: 5px; margin-top: 0; page-break-inside: avoid; }
#editor-container .summary-row { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #3A358E; font-size: 14px; }
#editor-container .summary-row:last-child { border-bottom: none; }
#editor-container .summary-row.total { font-weight: bold; background: #3A358E; color: white; margin-top: 10px; border-radius: 4px; }
#editor-container .summary-label { font-weight: bold; }
#editor-container .summary-value { min-width: 130px; text-align: right; }
#editor-container .summary-section h3 { margin-top: 15px; }
#editor-container .summary-section h3:first-child { margin-top: 0; margin-bottom: 10px; }
#editor-container .summary-section h3:not(:first-child) { margin-bottom: 10px; }

#editor-container .receipt-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
#editor-container .receipt-buttons button { font-size: 12px; padding: 6px 12px; background: #3A358E; color: white; border: none; border-radius: 4px; cursor: pointer; }
#editor-container .receipt-buttons button.delete-btn { background: #e74c3c; }
#editor-container .receipt-buttons button:hover { opacity: 0.8; }
#editor-container .receipt-table table { width: auto; table-layout: fixed; min-width: 0; }
#editor-container .receipt-table th:nth-child(1), #editor-container .receipt-table td:nth-child(1) { width: 15px; min-width: 15px; max-width: 15px; font-size: 11px; padding: 3px 2px; }
#editor-container .receipt-table th:nth-child(2), #editor-container .receipt-table td:nth-child(2) { width: 20px; min-width: 20px; max-width: 20px; font-size: 11px; padding: 3px 2px; }
#editor-container .receipt-table th:nth-child(3), #editor-container .receipt-table td:nth-child(3) { width: 10px; min-width: 10px; max-width: 10px; font-size: 11px; padding: 3px 2px; }
#editor-container .receipt-table th:nth-child(4), #editor-container .receipt-table td:nth-child(4) { width: 10px; min-width: 10px; max-width: 10px; font-size: 11px; padding: 3px 2px; }

/* === PRINT STYLES (COPIED FROM archive.html) === */
@media print {
  /* --- This is the archive.html wrapper logic --- */
  body > * { display: none !important; }
  #print-wrapper, #print-wrapper > * {
    display: block !important;
    position: static !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  
  /* --- This is the @page rule (from pettycash-statement) --- */
  @page {
    margin: 0.3in;
    size: legal landscape;
  }

  /* --- Now, ALL rules from pettycash-statement.html, prefixed with #print-wrapper --- */
  #print-wrapper .sidebar, #print-wrapper .button-group, #print-wrapper button, #print-wrapper .receipt-buttons { display: none !important; }
  #print-wrapper body { background: white; padding: 0; margin: 0; }
  #print-wrapper .main-wrapper { margin: 0 auto !important; box-shadow: none; display: block !important; width: 100% !important; max-width: none !important; }
  #print-wrapper .main-content { padding: 0 !important; width: 100% !important; }
  #print-wrapper .container { box-shadow: none; padding: 10px !important; font-family: 'Kalpurush', 'SolaimanLipi', 'Hind Siliguri', 'Roboto', sans-serif !important; width: 100% !important; margin: 0 !important; max-width: 100% !important; }
  #print-wrapper .container th, #print-wrapper .container td, #print-wrapper .summary-label, #print-wrapper .summary-value, #print-wrapper .summary-section h3, #print-wrapper .header span { font-weight: bold !important; color: #000 !important; white-space: normal !important; word-wrap: break-word !important; }
  #print-wrapper .summary-value span { text-align: right !important; }
  #print-wrapper .report-tables-wrapper { display: flex !important; gap: 10px !important; }
  #print-wrapper .receipt-table thead, #print-wrapper .expense-table thead { display: table-header-group; }
  #print-wrapper tbody { page-break-inside: auto; }
  #print-wrapper tbody tr:last-child { page-break-after: avoid; }
  #print-wrapper table { page-break-inside: auto !important; table-layout: auto !important; width: 100% !important; break-inside: auto; }
  #print-wrapper tr { page-break-inside: avoid; page-break-after: auto; break-inside: avoid; }
  #print-wrapper thead { display: table-header-group; }
  #print-wrapper .summary-section { page-break-inside: avoid !important; break-inside: avoid !important; font-size: 12px !important; padding: 6px !important; }
  #print-wrapper .summary-row { padding: 3px !important; font-size: 12px !important; color: #000 !important; }
  #print-wrapper .summary-section h3 { font-size: 14px !important; margin-bottom: 5px !important; color: #000 !important; margin-top: 10px !important; }
  #print-wrapper .summary-section h3:first-child { margin-top: 0 !important; }
  #print-wrapper .expense-table th, #print-wrapper .expense-table td { 
    writing-mode: horizontal-tb !important; 
    transform: none !important;
    text-align: center !important;
    vertical-align: middle !important;
    white-space: normal !important;
    word-wrap: break-word !important;
    color: #000 !important;
    width: auto !important;
    min-width: auto !important;
    max-width: none !important;
    padding: 6px 4px !important;
    font-size: 12px !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }
  #print-wrapper .expense-table th.normal:nth-child(1), #print-wrapper .expense-table td:nth-child(1) { 
    white-space: normal !important;
    word-wrap: break-word !important;
    font-size: 12px !important;
    width: 70px !important;
    max-width: 70px !important;
  }
  #print-wrapper .expense-table th.normal:nth-child(2), #print-wrapper .expense-table td:nth-child(2) { 
    white-space: normal !important;
    word-wrap: break-word !important;
    width: 110px !important;
    max-width: 110px !important;
    font-size: 12px !important;
  }
  #print-wrapper .expense-table th.normal:nth-child(3), 
  #print-wrapper .expense-table td:nth-child(3) { 
    width: 55px !important;
    min-width: 55px !important;
    max-width: 55px !important;
    white-space: normal !important;
    word-wrap: break-word !important;
    font-size: 12px !important;
  }
  #print-wrapper .expense-table th.normal:nth-child(4), 
  #print-wrapper .expense-table td:nth-child(4) { 
    width: 75px !important;
    min-width: 75px !important;
    max-width: 75px !important;
    white-space: normal !important;
    word-wrap: break-word !important;
    font-size: 12px !important;
  }
  #print-wrapper .expense-table th.normal:nth-child(5), #print-wrapper .expense-table td:nth-child(5) { 
    white-space: normal !important;
    word-wrap: break-word !important;
    font-size: 12px !important;
    width: 70px !important;
    max-width: 70px !important;
  }
  #print-wrapper .expense-table th.normal:nth-child(6), 
  #print-wrapper .expense-table td:nth-child(6) { 
    width: 60px !important;
    min-width: 60px !important;
    max-width: 50px !important;
    white-space: normal !important;
    word-wrap: break-word !important;
    font-size: 12px !important;
  }
  
  #print-wrapper .expense-table th:nth-last-child(2), #print-wrapper .expense-table td:nth-last-child(2) { 
    white-space: normal !important;
    word-wrap: break-word !important;
    font-size: 12px !important;
    width: 60px !important;
  }
  #print-wrapper .expense-table th:last-child, #print-wrapper .expense-table td:last-child { 
    white-space: normal !important;
    word-wrap: break-word !important;
    font-size: 12px !important;
    width: 60px !important;
  }
  #print-wrapper .expense-table th:not(.normal), #print-wrapper .expense-table td:not(:nth-child(1)):not(:nth-child(2)):not(:nth-child(3)):not(:nth-child(4)):not(:nth-child(5)):not(:nth-child(6)):not(:nth-last-child(2)):not(:last-child) { 
    width: 62px !important;
    min-width: 62px !important;
    max-width: none !important;
    padding: 2px 1px;
    white-space: normal;
    word-wrap: break-word;
    line-height: 1.1;
    writing-mode: horizontal-tb;
    transform: none;
  }
  #print-wrapper .receipt-table table { 
    width: auto !important; 
    table-layout: auto !important; 
  }
  #print-wrapper .receipt-table th, #print-wrapper .receipt-table td { 
    font-size: 12px !important; 
    padding: 4px 5px !important;
    white-space: normal !important;
    word-wrap: break-word !important;
    color: #000 !important;
    width: auto !important;
    min-width: auto !important;
    max-width: none !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }
  #print-wrapper .receipt-table th:nth-child(1), 
  #print-wrapper .receipt-table td:nth-child(1) { 
    width: 35px !important;
    max-width: 35px !important;
    white-space: normal !important;
    word-wrap: break-word !important;
  }
  #print-wrapper .receipt-table th:nth-child(2), 
  #print-wrapper .receipt-table td:nth-child(2) { 
    width: 50px !important;
    max-width: 50px !important;
    white-space: normal !important;
    word-wrap: break-word !important;
  }
  #print-wrapper .receipt-table th:nth-child(3), 
  #print-wrapper .receipt-table td:nth-child(3) { 
    width: 45px !important;
    max-width: 45px !important;
    white-space: normal !important;
    word-wrap: break-word !important;
  }
  #print-wrapper .receipt-table th:nth-child(4), 
  #print-wrapper .receipt-table td:nth-child(4) { 
    width: 35px !important;
    max-width: 35px !important;
    white-space: normal !important;
    word-wrap: break-word !important;
    max-width: 40px !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }
  #print-wrapper .section-title { 
    font-size: 20px !important; 
    padding: 10px !important; 
    font-weight: bold !important;
    color: #fff !important;
    background: #3A358E !important;
  }
  #print-wrapper .header h1 { font-size: 32px !important; color: #000 !important; }
  #print-wrapper .header h2 { 
    display: block !important; 
    font-size: 24px !important;
    margin-top: 10px !important;
    color: #000 !important;
  }
  #print-wrapper .header .field-group span {
    width: auto !important;
    padding: 0 5px !important;
  }
  #print-wrapper .header .field-group.center-group {
    flex-grow: 0 !important;
  }
  #print-wrapper .main-sections-wrapper { width: 100% !important; }
  #print-wrapper .receipt-section { flex: 0 0 28% !important; width: 28% !important; }
  #print-wrapper .expense-section { flex: 1 !important; width: 72% !important; }
  #print-wrapper .expense-table table { 
    min-width: 0 !important; 
    width: 100% !important; 
    table-layout: fixed !important;
  }
  #print-wrapper .static-cell {
    color: #000 !important;
  }
  #print-wrapper span {
    color: #000 !important;
  }
  #print-wrapper tfoot {
    display: table-row-group !important;
    page-break-inside: avoid !important;
    break-inside: avoid !important;
  }
  #print-wrapper .header .info-line {
    justify-content: space-between !important;
  }
  #print-wrapper .header .field-group:first-child {
    justify-content: flex-start !important;
    text-align: left !important;
  }
  #print-wrapper .header .field-group:first-child label {
    text-align: left !important;
  }
  #print-wrapper .header .field-group:first-child span {
    text-align: left !important;
    justify-content: flex-start !important;
  }
}
/* === END PRINT STYLES === */

/* Hide the print wrapper in normal view */
#print-wrapper {
  display: none;
  position: absolute;
  left: -9999px;
  width: 1400px; /* Match original width */
}
</style>
</head>
<body>
<div class="main-wrapper">
  <nav class="sidebar">
    <a class="sidebar-header" href="data entry.html" style="text-decoration: none; display: block; color: white;">üè† ‡¶π‡ßã‡¶Æ</a>
    <ul>
      <li><a href="data entry.html">üìù ‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</a></li>
      <li><a href="commission_calculation.html">üßÆ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® ‡¶ó‡¶£‡¶®‡¶æ</a></li>
      <li><a href="pettycash-statement.html">üí∞ ‡¶™‡ßá‡¶ü‡¶ø‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</a></li>
      <li><a href="Commission Statement.html">üìä ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</a></li>
      <li><a href="Manpower List (Editable).html">üë• ‡¶ú‡¶®‡¶¨‡¶≤ ‡¶ì ‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶ñ‡¶æ‡¶§</a></li>
      <li><a href="archive.html">üì¶ ‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠</a></li>
      <li><a href="data management.html">‚öôÔ∏è ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</a></li>
      <li><a href="edit-archive.html" class="active">‚úèÔ∏è ‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</a></li>
</ul>
  </nav>
  <div class="main-content">
    <div class="header">
      <img src="Logo.png" alt="‡¶ú‡ßÄ‡¶¨‡¶® ‡¶¨‡ßÄ‡¶Æ‡¶æ ‡¶ï‡¶∞‡ßç‡¶™‡ßã‡¶∞‡ßá‡¶∂‡¶® Logo" class="logo">
      <h2>‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</h2>
    </div>

    <div id="archive-picker-section">
      <h3>‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
      <div class="tab-buttons">
        <button class="tab-btn active" data-tab="pettycash" onclick="switchTab('pettycash')">‡¶™‡ßá‡¶ü‡¶ø‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</button>
        <button class="tab-btn" data-tab="commission" onclick="switchTab('commission')">‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</button>
      </div>

      <div id="pettycash-tab" class="tab-content active">
        <ul class="picker-list" id="pettycash-picker-list">
          </ul>
      </div>

      <div id="commission-tab" class="tab-content">
        <ul class="picker-list" id="commission-picker-list">
          </ul>
      </div>
    </div>
    <div id="editor-section">
      <h3>‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</h3>
      <div class="container" id="editor-container">
        </div>
      <button class="save-changes-btn" onclick="saveArchiveChanges()">‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      <button class="export-pdf-btn" onclick="exportToPDF()">PDF ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      <button class="cancel-btn" onclick="cancelEditing()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
  </div>
</div>

<div id="print-wrapper"></div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
let currentEditingArchiveId = null;
let currentEditingArchiveType = null;
let currentTab = 'pettycash';

// ===============================================
// ALL SCRIPT FUNCTIONS COPIED FROM archive.html
// ===============================================

function toBengaliNumerals(str) {
  if (str === null || str === undefined) str = '';
  const bengaliDigits = ['‡ß¶','‡ßß','‡ß®','‡ß©','‡ß™','‡ß´','‡ß¨','‡ß≠','‡ßÆ','‡ßØ'];
  let parts = String(str).split('.');
  parts[0] = parts[0].replace(/[0-9]/g, (d)=> bengaliDigits[parseInt(d)]);
  if (parts[1]) parts[1] = parts[1].replace(/[0-9]/g, (d)=> bengaliDigits[parseInt(d)]);
  return parts.join('.');
}
function toLatinNumerals(str) {
  if (str === null || str === undefined) str = '';
  const latin = {'‡ß¶':'0','‡ßß':'1','‡ß®':'2','‡ß©':'3','‡ß™':'4','‡ß´':'5','‡ß¨':'6','‡ß≠':'7','‡ßÆ':'8','‡ßØ':'9','.' : '.'};
  return String(str).replace(/[‡ß¶-‡ßØ\.]/g, (c)=> latin[c] || c);
}

/* === NEW FUNCTIONS for this page === */
function switchTab(tabName) {
  currentTab = tabName;
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.tab-btn[data-tab="${tabName}"]`)?.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(`${tabName}-tab`).classList.add('active');
}

function loadArchivePickers() {
  // Load Pettycash
  const pettyList = document.getElementById('pettycash-picker-list');
  const pettyArchives = JSON.parse(localStorage.getItem('pettyCashArchives') || '[]');
  pettyList.innerHTML = '';
  if (pettyArchives.length === 0) {
    pettyList.innerHTML = '<li class="no-archives">‡¶ï‡ßã‡¶® ‡¶™‡ßá‡¶ü‡¶ø‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</li>';
  }
  pettyArchives.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
  pettyArchives.forEach(archive => {
    const li = document.createElement('li');
    li.className = 'picker-item';
    li.innerHTML = `
      <div class="picker-item-info">
        <h4>${archive.name}</h4>
        <p>‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${new Date(archive.createdAt).toLocaleString('bn-BD')}</p>
      </div>
      <button onclick="loadArchiveForEditing('${archive.id}', 'pettycash')">‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    `;
    pettyList.appendChild(li);
  });

  // Load Commission
  const commList = document.getElementById('commission-picker-list');
  const commArchives = JSON.parse(localStorage.getItem('commissionArchives') || '[]');
  commList.innerHTML = '';
  if (commArchives.length === 0) {
    commList.innerHTML = '<li class="no-archives">‡¶ï‡ßã‡¶® ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® ‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</li>';
  }
  commArchives.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
  commArchives.forEach(archive => {
    const li = document.createElement('li');
    li.className = 'picker-item';
    li.innerHTML = `
      <div class="picker-item-info">
        <h4>${archive.name}</h4>
        <p>‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${new Date(archive.createdAt).toLocaleString('bn-BD')}</p>
      </div>
      <button onclick="loadArchiveForEditing('${archive.id}', 'commission')">‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    `;
    commList.appendChild(li);
  });
}

function loadArchiveForEditing(id, type) {
  currentEditingArchiveId = id;
  currentEditingArchiveType = type;
  const storageKey = type === 'pettycash' ? 'pettyCashArchives' : 'commissionArchives';
  const archives = JSON.parse(localStorage.getItem(storageKey) || '[]');
  const archive = archives.find(a => String(a.id) === String(id));
  if (!archive) {
    alert('‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!');
    return;
  }

  // Hide picker, show editor
  document.getElementById('archive-picker-section').style.display = 'none';
  document.getElementById('editor-section').style.display = 'block';

  if (type === 'pettycash') editPettyCashArchive(archive);
  else editCommissionArchive(archive);
  
  document.getElementById('editor-section').scrollIntoView({ behavior: 'smooth' });
}

function cancelEditing() {
  if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶∏‡¶¨ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶æ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§')) {
    document.getElementById('editor-section').style.display = 'none';
    document.getElementById('archive-picker-section').style.display = 'block';
    document.getElementById('editor-container').innerHTML = ''; // Clear the editor
    currentEditingArchiveId = null;
    currentEditingArchiveType = null;
  }
}

/* === EDITOR LOADER FUNCTIONS (COPIED FROM archive.html) === */
// ================== UPDATED FUNCTION (NEW GROUPING LOGIC) ==================
/* Pettycash editor: exact copy of pettycash-statement with filled data, editable */
function editPettyCashArchive(archive) {
  const data = archive.data;
  const editor = document.getElementById('editor-container');

  editor.className = 'container pettycash-editor';
  editor.innerHTML = `
    <div class="header">
      <img src="Logo.png" alt="‡¶ú‡ßÄ‡¶¨‡¶® ‡¶¨‡ßÄ‡¶Æ‡¶æ ‡¶ï‡¶∞‡ßç‡¶™‡ßã‡¶∞‡ßá‡¶∂‡¶® Logo" style="max-width: 400px; height: auto; margin-bottom: 10px;">
      <h2 style="font-size: 22px; color: #3A358E; margin-bottom: 10px; font-weight: bold;">‡¶™‡ßá‡¶ü‡¶ø‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
      <div class="info-line">
        <div class="field-group">
          <label>‡¶Ö‡¶´‡¶ø‡¶∏‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
          <input type="text" id="edit-office-name" style="width: 250px;">
        </div>
        <div class="field-group date-range center-group">
          <label>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
          <input type="text" id="edit-start-date" placeholder="dd/mm/yy" style="width: 100px;">
          <label>‡¶π‡¶§‡ßá:</label>
          <input type="text" id="edit-end-date" placeholder="dd/mm/yy" style="width: 100px;">
        </div>
        <div class="field-group" style="flex-direction: column; align-items: flex-end;">
          <div class="field-group" style="margin: 2px 0;">
            <label>‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶Ç:</label>
            <input type="text" id="edit-statement-no" style="width: 150px;">
          </div>
          <div class="field-group" style="margin: 2px 0;">
            <label>‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶ï‡ßã‡¶°:</label>
            <input type="text" id="edit-office-code" style="width: 150px;">
          </div>
        </div>
      </div>
    </div>

    <div class="main-sections-wrapper">
      <div class="receipt-section">
        <div class="section-title">‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡¶ø‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£‡¶Æ‡ßÇ‡¶π</div>
        <table class="receipt-table">
          <thead>
            <tr>
              <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
              <th>‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡¶ø‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£‡¶Æ‡ßÇ‡¶π</th>
              <th>‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ</th>
              <th>‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ</th>
            </tr>
          </thead>
          <tbody id="edit-receipt-body"></tbody>
          <tfoot id="receipt-total">
            <tr>
              <td colspan="2" style="text-align: right; font-weight: bold;">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü</td>
              <td id="edit-receipt-bank-total" class="static-cell">‡ß¶</td>
              <td id="edit-receipt-cash-total" class="static-cell">‡ß¶</td>
            </tr>
          </tfoot>
        </table>
        <div class="receipt-buttons">
          <button onclick="addReceiptRow('edit-receipt-body')">‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
          <button class="delete-btn" onclick="deleteLastReceiptRow('edit-receipt-body')">‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡¶ø ‡¶¨‡¶æ‡¶¶ ‡¶¶‡¶ø‡¶®</button>
        </div>

        <div class="summary-section">
          <h3>‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</h3>
          <h3>‡¶ï) ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶ú‡ßá‡¶∞:</h3>
          <div class="summary-row">
            <span class="summary-label">‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ú‡ßá‡¶∞:</span>
            <span class="summary-value"><input type="text" class="amount-input" id="summary-opening-bank" value="‡ß¶" readonly></span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ú‡ßá‡¶∞:</span>
            <span class="summary-value"><input type="text" class="amount-input" id="summary-opening-cash" value="‡ß¶" readonly></span>
          </div>

          <h3>‡¶ñ) ‡¶ö‡¶≤‡¶§‡¶ø ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡¶ø:</h3>
          <div class="summary-row">
            <span class="summary-label">‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶´‡¶æ‡¶®‡ßç‡¶° ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡¶ø:</span>
            <span class="summary-value"><input type="text" class="amount-input" id="summary-current-bank-receipt" value="‡ß¶" readonly></span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶´‡¶æ‡¶®‡ßç‡¶° ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡¶ø:</span>
            <span class="summary-value"><input type="text" class="amount-input" id="summary-current-cash-receipt" value="‡ß¶" readonly></span>
          </div>

          <h3>‡¶ó) ‡¶Æ‡ßã‡¶ü ‡¶´‡¶æ‡¶®‡ßç‡¶° (‡¶ú‡ßá‡¶∞ ‡¶∏‡¶π):</h3>
          <div class="summary-row">
            <span class="summary-label">‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶ú‡ßá‡¶∞ ‡¶ì ‡¶´‡¶æ‡¶®‡ßç‡¶° ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡¶ø‡¶∏‡¶π ‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶´‡¶æ‡¶®‡ßç‡¶°:</span>
            <span class="summary-value"><input type="text" class="amount-input" id="summary-total-bank-fund" value="‡ß¶" readonly></span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶ú‡ßá‡¶∞ ‡¶ì ‡¶´‡¶æ‡¶®‡ßç‡¶° ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡¶ø‡¶∏‡¶π ‡¶Æ‡ßã‡¶ü ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶´‡¶æ‡¶®‡ßç‡¶°:</span>
            <span class="summary-value"><input type="text" class="amount-input" id="summary-total-cash-fund" value="‡ß¶" readonly></span>
          </div>

          <h3>‡¶ò) ‡¶ö‡¶≤‡¶§‡¶ø ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö:</h3>
          <div class="summary-row">
            <span class="summary-label">‡¶ö‡¶≤‡¶§‡¶ø ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ñ‡¶∞‡¶ö:</span>
            <span class="summary-value"><input type="text" class="amount-input" id="total-bank-expense" value="‡ß¶" readonly></span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡¶ö‡¶≤‡¶§‡¶ø ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ñ‡¶∞‡¶ö:</span>
            <span class="summary-value"><input type="text" class="amount-input" id="total-cash-expense" value="‡ß¶" readonly></span>
          </div>

          <h3>‡¶ô) ‡¶Ö‡¶¨‡¶∂‡¶ø‡¶∑‡ßç‡¶ü ‡¶ú‡ßá‡¶∞:</h3>
          <div class="summary-row">
            <span class="summary-label">‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶™‡¶∞ ‡¶Ö‡¶¨‡¶∂‡¶ø‡¶∑‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ü‡¶æ‡¶ï‡¶æ:</span>
            <span class="summary-value"><input type="text" class="amount-input" id="bank-balance" value="‡ß¶" readonly></span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶™‡¶∞ ‡¶Ö‡¶¨‡¶∂‡¶ø‡¶∑‡ßç‡¶ü ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ü‡¶æ‡¶ï‡¶æ:</span>
            <span class="summary-value"><input type="text" class="amount-input" id="cash-balance" value="‡ß¶" readonly></span>
          </div>
        </div>

        <div class="summary-section verification-summary" style="margin-top: 15px;">
          <h3 style="margin-bottom: 10px;">‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶ï‡¶∞‡¶£ (Verification)</h3>
          <div class="summary-row">
            <span class="summary-label">‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ì ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó‡¶´‡¶≤:</span>
            <span class="summary-value"><input type="text" id="verify-bank-cash-total" value="‡ß¶" readonly></span>
          </div>
          <div class="summary-row">
            <span class="summary-label">‡¶∏‡¶ï‡¶≤ ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶Ø‡ßã‡¶ó‡¶´‡¶≤ (‡¶Æ‡ßã‡¶ü + ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶æ):</span>
            <span class="summary-value"><input type="text" id="verify-column-total" value="‡ß¶" readonly></span>
          </div>
          <div class="summary-row total" style="background: #e74c3c;">
            <span class="summary-label">‡¶¨‡ßç‡¶Ø‡¶¨‡¶ß‡¶æ‡¶®:</span>
            <span class="summary-value"><input type="text" id="verify-difference" value="‡ß¶" readonly style="color: white; font-weight: bold;"></span>
          </div>
        </div>
      </div>

      <div class="expense-section">
        <div class="expense-table">
          <div class="section-title">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶ì ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£‡¶Æ‡ßÇ‡¶π</div>
          <table>
            <thead>
              <tr>
                <th class="normal">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                <th class="normal">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£‡¶Æ‡ßÇ‡¶π</th>
                <th class="normal">‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Ç <button onclick="generateVoucherNumbersEdit()" style="font-size: 10px; padding: 2px 4px; background:#fff; color:#3A358E; border:1px solid #3A358E; border-radius:3px; cursor:pointer;">‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶§‡ßà‡¶∞‡ßÄ ‡¶ï‡¶∞‡ßÅ‡¶®</button></th>
                <th class="normal">‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ü‡¶æ‡¶ï‡¶æ</th>
                <th class="normal">‡¶ö‡ßá‡¶ï ‡¶®‡¶æ‡¶Ç <button onclick="generateCheckNumbersEdit()" style="font-size: 10px; padding: 2px 4px; background:#fff; color:#3A358E; border:1px solid #3A358E; border-radius:3px; cursor:pointer;">‡¶ö‡ßá‡¶ï ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶§‡ßà‡¶∞‡ßÄ ‡¶ï‡¶∞‡ßÅ‡¶®</button></th>
                <th class="normal">‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ü‡¶æ‡¶ï‡¶æ</th>
                <th>‡ßß‡¶Æ ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®</th>
                <th>‡¶®‡¶¨‡¶æ‡¶Ø‡¶º‡¶® ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®</th>
                <th>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶¨‡ßã‡¶®‡¶æ‡¶∏</th>
                <th>‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ ‡¶¨‡ßá‡¶§‡¶® (‡¶Ö‡¶´‡¶ø‡¶∏)</th>
                <th>‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ ‡¶¨‡ßá‡¶§‡¶® (‡¶â‡¶®‡ßç‡¶®‡¶Ø‡¶º‡¶®)</th>
                <th>‡¶ü‡ßá‡¶≤‡¶ø‡¶´‡ßã‡¶® ‡¶¨‡¶ø‡¶≤</th>
                <th>‡¶Æ‡ßÅ‡¶¶‡ßç‡¶∞‡¶£ ‡¶ì ‡¶Æ‡¶£‡¶ø‡¶π‡¶æ‡¶∞‡¶ø ‡¶ñ‡¶∞‡¶ö</th>
                <th>‡¶≠‡ßç‡¶∞‡¶Æ‡¶£ ‡¶ì ‡¶Ø‡¶æ‡¶§‡¶æ‡¶Ø‡¶º‡¶æ‡¶§ ‡¶ñ‡¶∞‡¶ö</th>
                <th>‡¶â‡ßé‡¶∏‡¶¨ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ (‡¶Ö‡¶´‡¶ø‡¶∏)</th>
                <th>‡¶â‡ßé‡¶∏‡¶¨ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ (‡¶â‡¶®‡ßç‡¶®‡¶Ø‡¶º‡¶®)</th>
                <th>‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞‡ßÄ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶´‡¶ø</th>
                <th>‡¶≤‡¶æ‡¶û‡ßç‡¶ö‡¶≠‡¶æ‡¶§‡¶æ (‡¶Ö‡¶´‡¶ø‡¶∏)</th>
                <th>‡¶≤‡¶æ‡¶û‡ßç‡¶ö‡¶≠‡¶æ‡¶§‡¶æ (‡¶â‡¶®‡ßç‡¶®‡¶Ø‡¶º‡¶®)</th>
                <th>‡¶∞‡¶æ‡¶ú‡¶∏‡ßç‡¶¨ ‡¶ü‡¶ø‡¶ï‡ßá‡¶ü</th>
                <th>‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶¨‡¶ø‡¶≤</th>
                <th>‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶è‡¶≤‡¶æ‡¶â‡¶®‡ßç‡¶∏</th>
                <th>‡¶â‡ßé‡¶∏‡¶æ‡¶π ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ (‡¶Ö‡¶´‡¶ø‡¶∏)</th>
                <th>‡¶â‡ßé‡¶∏‡¶æ‡¶π ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ (‡¶â‡¶®‡ßç‡¶®‡¶Ø‡¶º‡¶®)</th>
                <th>‡¶¨‡ßà‡¶∂‡¶æ‡¶ñ‡ßÄ ‡¶≠‡¶æ‡¶§‡¶æ (‡¶Ö‡¶´‡¶ø‡¶∏)</th>
                <th>‡¶¨‡ßà‡¶∂‡¶æ‡¶ñ‡ßÄ ‡¶≠‡¶æ‡¶§‡¶æ (‡¶â‡¶®‡ßç‡¶®‡¶Ø‡¶º‡¶®)</th>
                <th>‡¶∂‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶§‡¶ø ‡¶ì ‡¶¨‡¶ø‡¶®‡ßã‡¶¶‡¶® ‡¶≠‡¶æ‡¶§‡¶æ</th>
                <th>‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ñ‡¶∞‡¶ö</th>
                <th>‡¶™‡¶§‡ßç‡¶∞‡¶ø‡¶ï‡¶æ ‡¶¨‡¶ø‡¶≤</th>
                <th>‡¶¨‡¶ø‡¶¨‡¶ø‡¶ß ‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º</th>
                <th>‡¶Ü‡¶∏‡¶¨‡¶æ‡¶¨‡¶™‡¶§‡ßç‡¶∞ ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º</th>
                <th>‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®</th>
                <th>‡¶°‡¶æ‡¶ï ‡¶ì ‡¶§‡¶æ‡¶∞ ‡¶ñ‡¶∞‡¶ö</th>
                <th>‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶≠‡¶æ‡¶°‡¶º‡¶æ</th>
                <th>‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶ñ‡¶∞‡¶ö (‡¶Ö‡¶´‡¶ø‡¶∏)</th>
                <th>‡¶¶‡ßà‡¶É‡¶Æ‡¶É‡¶≠‡¶ø‡¶É ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶¨‡¶ø‡¶≤</th>
                <th>‡¶Æ‡ßã‡¶ü</th>
                <th>‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶æ</th>
              </tr>
            </thead>
            <tbody id="edit-expense-body"></tbody>
            <tfoot id="expense-total">
              <tr>
                <td colspan="2" style="text-align: right; font-weight: bold;">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü</td>
                <td></td>
                <td id="expense-bank-total" class="static-cell">‡ß¶</td>
                <td></td>
                <td id="expense-cash-total" class="static-cell">‡ß¶</td>

                <td id="col-1st-year-commission" class="static-cell">‡ß¶</td>
                <td id="col-renewal-commission" class="static-cell">‡ß¶</td>
                <td id="col-production-bonus" class="static-cell">‡ß¶</td>
                <td id="col-employee-salary-office" class="static-cell">‡ß¶</td>
                <td id="col-employee-salary-dev" class="static-cell">‡ß¶</td>
                <td id="col-telephone-bill" class="static-cell">‡ß¶</td>
                <td id="col-printing-stationery" class="static-cell">‡ß¶</td>
                <td id="col-travel-expense" class="static-cell">‡ß¶</td>
                <td id="col-festival-bonus-office" class="static-cell">‡ß¶</td>
                <td id="col-festival-bonus-dev" class="static-cell">‡ß¶</td>
                <td id="col-medical-fee" class="static-cell">‡ß¶</td>
                <td id="col-lunch-office" class="static-cell">‡ß¶</td>
                <td id="col-lunch-dev" class="static-cell">‡ß¶</td>
                <td id="col-revenue-ticket" class="static-cell">‡ß¶</td>
                <td id="col-internet-bill" class="static-cell">‡ß¶</td>
                <td id="col-cash-allowance" class="static-cell">‡ß¶</td>
                <td id="col-incentive-office" class="static-cell">‡ß¶</td>
                <td id="col-incentive-dev" class="static-cell">‡ß¶</td>
                <td id="col-boishakhi-office" class="static-cell">‡ß¶</td>
                <td id="col-boishakhi-dev" class="static-cell">‡ß¶</td>
                <td id="col-shraboni-entertainment" class="static-cell">‡ß¶</td>
                <td id="col-general-expense" class="static-cell">‡ß¶</td>
                <td id="col-newspaper-bill" class="static-cell">‡ß¶</td>
                <td id="col-misc-expense" class="static-cell">‡ß¶</td>
                <td id="col-furniture-purchase" class="static-cell">‡ß¶</td>
                <td id="col-bonus-commission" class="static-cell">‡ß¶</td>
                <td id="col-postal-expense" class="static-cell">‡ß¶</td>
                <td id="col-office-rent" class="static-cell">‡ß¶</td>
                <td id="col-medical-office" class="static-cell">‡ß¶</td>
                <td id="col-employee-bill" class="static-cell">‡ß¶</td>

                <td id="expense-grand-total" class="static-cell">‡ß¶</td>
                <td id="expense-contra-total" class="static-cell">‡ß¶</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  `;

  /* Populate header */
  document.getElementById('edit-office-name').value = data.officeName || '';
  document.getElementById('edit-start-date').value = data.startDate || '';
  document.getElementById('edit-end-date').value = data.endDate || '';
  document.getElementById('edit-office-code').value = data.officeCode || '';
  document.getElementById('edit-statement-no').value = data.statementNo || '';

  /* Receipts */
  const receiptBody = document.getElementById('edit-receipt-body');
  receiptBody.innerHTML = '';
  const receipts = Array.isArray(data.receipts) ? data.receipts : [];
  if (receipts.length) {
    receipts.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="editable-cell"><input type="text" class="receipt-date" value="${r.date || ''}" placeholder="dd/mm/yy"></td>
        <td class="editable-cell"><input type="text" value="${r.details || ''}"></td>
        <td class="editable-cell"><input type="text" class="amount-input" value="${toBengaliNumerals(parseFloat(r.bank || 0).toFixed(2))}"></td>
        <td class="editable-cell"><input type="text" class="amount-input" value="${toBengaliNumerals(parseFloat(r.cash || 0).toFixed(2))}"></td>
      `;
      receiptBody.appendChild(tr);
    });
  } else {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="editable-cell"><input type="text" class="receipt-date" value="" placeholder="dd/mm/yy"></td>
      <td class="editable-cell"><input type="text" value="‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶ú‡ßá‡¶∞"></td>
      <td class="editable-cell"><input type="text" class="amount-input" value="‡ß¶"></td>
      <td class="editable-cell"><input type="text" class="amount-input" value="‡ß¶"></td>
    `;
    receiptBody.appendChild(tr);
  }

  /* Populate FULL summary from saved archive data (as a baseline) */
  const totals = data.totals || {};
  document.getElementById('summary-opening-bank').value = toBengaliNumerals(data.openingBank || totals.summaryOpeningBank || '‡ß¶');
  document.getElementById('summary-opening-cash').value = toBengaliNumerals(data.openingCash || totals.summaryOpeningCash || '‡ß¶');
  document.getElementById('summary-current-bank-receipt').value = toBengaliNumerals(totals.summaryCurrentBankReceipt || '‡ß¶');
  document.getElementById('summary-current-cash-receipt').value = toBengaliNumerals(totals.summaryCurrentCashReceipt || '‡ß¶');
  document.getElementById('summary-total-bank-fund').value = toBengaliNumerals(totals.summaryTotalBankFund || '‡ß¶');
  document.getElementById('summary-total-cash-fund').value = toBengaliNumerals(totals.summaryTotalCashFund || '‡ß¶');
  document.getElementById('total-bank-expense').value = toBengaliNumerals(totals.totalBankExpense || '‡ß¶');
  document.getElementById('total-cash-expense').value = toBengaliNumerals(totals.totalCashExpense || '‡ß¶');
  document.getElementById('bank-balance').value = toBengaliNumerals(totals.bankBalance || '‡ß¶');
  document.getElementById('cash-balance').value = toBengaliNumerals(totals.cashBalance || '‡ß¶');


  /* Expense rows: exact columns */
  const expenseBody = document.getElementById('edit-expense-body');
  expenseBody.innerHTML = '';

  const headerTitles = Array.from(editor.querySelector('.expense-table thead tr').children).map(th => th.textContent.replace(/‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶§‡ßà‡¶∞‡ßÄ ‡¶ï‡¶∞‡ßÅ‡¶®|‡¶ö‡ßá‡¶ï ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶§‡ßà‡¶∞‡ßÄ ‡¶ï‡¶∞‡ßÅ‡¶®/g,'').trim());
  const headerIndex = {};
  headerTitles.forEach((t,i)=> headerIndex[t]=i);

  const expenses = Array.isArray(data.expenses) ? data.expenses : [];
  const groups = {};
  
  // ================== NEW GROUPING LOGIC START ==================
  expenses.forEach(entry => {
      let groupKey;
      const isCommission = entry.expenseColumn === '‡ßß‡¶Æ ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®' || entry.expenseColumn === '‡¶®‡¶¨‡¶æ‡¶Ø‡¶º‡¶® ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®';

      if (isCommission && entry.sessionId) {
          // Group commissions ONLY if they share a sessionId
          groupKey = `commission_session_${entry.sessionId}`;
      } else {
          // All other entries (office, staff, contra, or old commissions) get a unique key
          groupKey = `unique_${entry.id || (Math.random() * 1000000)}`;
      }
      
      if (!groups[groupKey]) {
          let displayDetails;
          // For commission groups, show agent name. For others, show entry details.
          if (isCommission && entry.sessionId) {
              displayDetails = entry.manpowerName || '‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®';
          } else if (entry.manpowerName) {
              displayDetails = entry.manpowerName;
          } else {
              displayDetails = entry.details;
          }

          groups[groupKey] = {
            id: entry.id,
            date: entry.date,
            details: displayDetails,
            manpowerCode: entry.manpowerCode,
            manpowerName: entry.manpowerName,
            voucherNo: entry.voucherNo,
            checkNo: entry.checkNo,
            contraFromExpense: 0,
            contraFromInput: 0,
            paymentType: entry.paymentType,
            sessionId: entry.sessionId, // <-- Store the session ID
            columns: {}
          };
      }
  // ================== NEW GROUPING LOGIC END ==================

      const amount = parseFloat(entry.amount || 0);
      
      if (entry.expenseColumn === '‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶æ') {
          groups[groupKey].contraFromExpense += amount;
      } else {
          const columnName = entry.expenseColumn;
          if (columnName) { 
              if (!groups[groupKey].columns[columnName]) {
                  groups[groupKey].columns[columnName] = 0;
              }
              groups[groupKey].columns[columnName] += amount;
          }

          const contraInputVal = parseFloat(entry.contraAmount || 0);
          groups[groupKey].contraFromInput = Math.max(
              groups[groupKey].contraFromInput, 
              contraInputVal
          );
      }
  });


  Object.values(groups).forEach(g => {
    const tr = document.createElement('tr');
    
    tr.dataset.originalId = g.id || '';
    tr.dataset.originalManpowerCode = g.manpowerCode || '';
    tr.dataset.originalContraFromExpense = g.contraFromExpense || 0;
    tr.dataset.originalSessionId = g.sessionId || ''; // <-- Store session ID in data attribute

    const cells = new Array(headerTitles.length).fill(''); // Empty array

    const d = new Date(g.date);
    let ddmmyy = '';
    if (!isNaN(d.getTime())) {
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = String(d.getFullYear()%100).padStart(2,'0');
      ddmmyy = toBengaliNumerals(`${dd}/${mm}/${yy}`);
    }
    cells[headerIndex['‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ']] = `<td class="editable-cell"><input type="text" class="expense-date" value="${ddmmyy}" placeholder="dd/mm/yy"></td>`;
    cells[headerIndex['‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£‡¶Æ‡ßÇ‡¶π']] = `<td class="editable-cell"><input type="text" value="${g.details}"></td>`;
    cells[headerIndex['‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Ç']] = `<td class="editable-cell"><input type="text" value="${toBengaliNumerals(g.voucherNo || '')}"></td>`;
    cells[headerIndex['‡¶ö‡ßá‡¶ï ‡¶®‡¶æ‡¶Ç']] = `<td class="editable-cell"><input type="text" value="${toBengaliNumerals(g.checkNo || '')}"></td>`;

    let rowTotal = 0;
    
    // ================== THIS IS THE CRITICAL FIX (PROBLEM 3) ==================
    // Loop through ALL 30 expense column headers (from index 6 to 35)
    for (let i = 6; i < headerTitles.length - 2; i++) { // Loop from 6 up to (but not including) Total and Contra
        const colName = headerTitles[i];
        const amt = parseFloat(g.columns[colName] || 0);
        rowTotal += amt;
        cells[i] = `<td class="editable-cell"><input type="text" class="amount-input" value="${toBengaliNumerals(amt.toFixed(2))}"></td>`;
    }
    // ================== END OF FIX ==================

    const finalContra = (g.contraFromExpense || 0) + (g.contraFromInput || 0);
    if (g.paymentType === 'bank') {
      const bankVal = rowTotal + finalContra;
      cells[headerIndex['‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ü‡¶æ‡¶ï‡¶æ']] = `<td class="editable-cell"><input type="text" class="amount-input" value="${toBengaliNumerals(bankVal.toFixed(2))}"></td>`;
      cells[headerIndex['‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ü‡¶æ‡¶ï‡¶æ']] = `<td class="editable-cell"><input type="text" class="amount-input" value="‡ß¶"></td>`;
    } else {
      const cashVal = rowTotal + finalContra;
      cells[headerIndex['‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ü‡¶æ‡¶ï‡¶æ']] = `<td class="editable-cell"><input type="text" class="amount-input" value="${toBengaliNumerals(cashVal.toFixed(2))}"></td>`;
      cells[headerIndex['‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ü‡¶æ‡¶ï‡¶æ']] = `<td class="editable-cell"><input type="text" class="amount-input" value="‡ß¶"></td>`;
    }

    cells[headerIndex['‡¶Æ‡ßã‡¶ü']] = `<td class="editable-cell"><input type="text" class="amount-input" value="${toBengaliNumerals(rowTotal.toFixed(2))}" readonly></td>`;
    cells[headerIndex['‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶æ']] = `<td class="editable-cell"><input type="text" class="amount-input contra-input" value="${finalContra>0?toBengaliNumerals(finalContra.toFixed(2)):''}" placeholder=""></td>`;
    
    tr.innerHTML = cells.join('');
    expenseBody.appendChild(tr);
  });

  /* Inputs restriction */
  editor.querySelectorAll('.amount-input').forEach(input => {
    input.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^‡ß¶-‡ßØ.]/g, '');
    });
  });

  /* Date pickers */
  flatpickr("#edit-start-date", { dateFormat: "d/m/y", allowInput: true });
  flatpickr("#edit-end-date", { dateFormat: "d/m/y", allowInput: true });
  flatpickr(".receipt-date", { dateFormat: "d/m/y", allowInput: true });
  flatpickr(".expense-date", { dateFormat: "d/m/y", allowInput: true });

  /* Calculations (Run once to recalculate and sync all fields) */
  calculateReceiptTotalsEdit();
  calculateExpenseTotalsEdit();
  updateBalancesEdit();
  updateVerificationSummaryEdit();

  /* Listeners */
  receiptBody.addEventListener('input', () => { calculateReceiptTotalsEdit(); updateBalancesEdit(); updateVerificationSummaryEdit(); });
  expenseBody.addEventListener('input', (e) => {
    const tr = e.target.closest('tr');
    if (tr) {
      const inputs = Array.from(tr.querySelectorAll('input'));
      if (inputs.length < 38) return; // safety check (now 38 columns total)
      
      const totalInput = inputs[36]; // '‡¶Æ‡ßã‡¶ü' is 2nd to last (index 36)
      let sum = 0;
      for (let i = 6; i <= 35; i++) { // Loop through all 30 expense inputs (index 6 to 35)
        sum += parseFloat(toLatinNumerals(inputs[i].value)) || 0;
      }
      if (totalInput) totalInput.value = toBengaliNumerals(sum.toFixed(2));

      const bankInput = inputs[3];
      const cashInput = inputs[5];
      const contraInput = inputs[37]; // '‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶æ' is last (index 37)
      const contraVal = parseFloat(toLatinNumerals(contraInput.value)) || 0;
      const paymentTypeIsBank = (parseFloat(toLatinNumerals(bankInput.value)) || 0) > 0;
      const targetVal = sum + contraVal;
      if (paymentTypeIsBank) {
        bankInput.value = toBengaliNumerals(targetVal.toFixed(2));
        cashInput.value = '‡ß¶';
      } else {
        cashInput.value = toBengaliNumerals(targetVal.toFixed(2));
        bankInput.value = '‡ß¶';
      }
    }
    calculateExpenseTotalsEdit();
    updateBalancesEdit();
    updateVerificationSummaryEdit();
  });
}

/* Commission editor (unchanged structure, fully editable) */
function editCommissionArchive(archive) {
  const data = archive.data;
  const editor = document.getElementById('editor-container');

  editor.className = 'container commission-editor';
  editor.innerHTML = `
    <div class="header">
      <img src="Logo.png" alt="‡¶ú‡ßÄ‡¶¨‡¶® ‡¶¨‡ßÄ‡¶Æ‡¶æ ‡¶ï‡¶∞‡ßç‡¶™‡ßã‡¶∞‡ßá‡¶∂‡¶® Logo" style="max-width: 400px; height: auto; margin-bottom: 10px;">
      <div class="info-line">
        <div class="field-group"><label>‡¶Ö‡¶´‡¶ø‡¶∏‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label><input type="text" id="edit-office-name" style="width: 250px;"></div>
        <div class="field-group date-range center-group">
          <label>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
          <input type="text" id="edit-start-date" placeholder="dd/mm/yy" style="width: 100px;">
          <label>‡¶π‡¶§‡ßá:</label>
          <input type="text" id="edit-end-date" placeholder="dd/mm/yy" style="width: 100px;">
        </div>
        <div class="field-group"><label>‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶ï‡ßã‡¶°:</label><input type="text" id="edit-office-code" style="width: 150px;"></div>
      </div>
    </div>
    <div class="main-sections-wrapper">
      <div class="expense-section">
        <div class="expense-table">
          <div class="section-title"></div>
          <table>
            <thead>
              <tr>
                <th class="normal">‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï ‡¶®‡¶Ç <button onclick="generateSequentialNumbers('edit-commission-body', 0, false)" style="font-size: 10px; padding: 2px 4px; background:#fff; color:#3A358E; border:1px solid #3A358E; border-radius:3px; cursor:pointer;">‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï ‡¶®‡¶Ç ‡¶§‡ßà‡¶∞‡ßÄ ‡¶ï‡¶∞‡ßÅ‡¶®</button></th>
                <th class="normal">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                <th class="normal">‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                <th class="normal">‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡ßã‡¶°</th>
                <th class="normal">‡¶¨‡¶ø‡¶≤ ‡¶®‡¶Ç</th>
                <th class="normal">‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶®‡¶Ç <button onclick="generateSequentialNumbers('edit-commission-body', 5, true)" style="font-size: 10px; padding: 2px 4px; background:#fff; color:#3A358E; border:1px solid #3A358E; border-radius:3px; cursor:pointer;">‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶§‡ßà‡¶∞‡ßÄ ‡¶ï‡¶∞‡ßÅ‡¶®</button></th>
                <th>‡ßß‡¶Æ ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®</th>
                <th>‡¶®‡¶¨‡¶æ‡¶Ø‡¶º‡¶® ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®</th>
                <th>‡¶Æ‡ßã‡¶ü</th>
              </tr>
            </thead>
            <tbody id="edit-commission-body"></tbody>
            <tfoot>
              <tr>
                <td colspan="6" style="text-align:right; font-weight:bold; border: 1px solid #3A358E;">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü</td>
                <td id="edit-total-first-year" class="static-cell">‡ß¶</td>
                <td id="edit-total-renewal" class="static-cell">‡ß¶</td>
                <td id="edit-total-commission" class="static-cell">‡ß¶</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  `;

  document.getElementById('edit-office-name').value = data.officeName || '';
  document.getElementById('edit-start-date').value = data.startDate || '';
  document.getElementById('edit-end-date').value = data.endDate || '';
  document.getElementById('edit-office-code').value = data.officeCode || '';

  const body = document.getElementById('edit-commission-body');
  body.innerHTML = '';
  (data.entries || []).forEach(entry => {
    const firstYear = parseFloat(entry.firstYearComm) || 0;
    const renewal = parseFloat(entry.renewalComm) || 0;
    const total = parseFloat(entry.totalComm) || (firstYear + renewal);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="editable-cell"><input type="text" class="amount-input" value="${toBengaliNumerals(entry.serial || '')}"></td>
      <td class="editable-cell"><input type="text" class="commission-date" value="${entry.date || ''}"></td>
      <td class="editable-cell"><input type="text" value="${entry.agentName || ''}"></td>
      <td class="editable-cell"><input type="text" class="amount-input" value="${toBengaliNumerals(entry.agentCode || '')}"></td>
      <td class="editable-cell"><input type="text" class="amount-input" value="${toBengaliNumerals(entry.billNo || '')}"></td>
      <td class="editable-cell"><input type="text" class="amount-input" value="${toBengaliNumerals(entry.voucherNo || '')}"></td>
      <td class="editable-cell"><input type="text" class="amount-input" value="${toBengaliNumerals(firstYear.toFixed(2))}"></td>
      <td class="editable-cell"><input type="text" class="amount-input" value="${toBengaliNumerals(renewal.toFixed(2))}"></td>
      <td class="editable-cell"><input type="text" class="amount-input" value="${toBengaliNumerals(total.toFixed(2))}" readonly></td>
    `;
    body.appendChild(tr);
  });

  editor.querySelectorAll('.amount-input').forEach(input => {
    input.addEventListener('input', (e)=> e.target.value = e.target.value.replace(/[^‡ß¶-‡ßØ.]/g,''));
  });
  flatpickr("#edit-start-date", { dateFormat: "d/m/y", allowInput: true });
  flatpickr("#edit-end-date", { dateFormat: "d/m/y", allowInput: true });
  flatpickr(".commission-date", { dateFormat: "d/m/y", allowInput: true });

  body.addEventListener('input', calculateEditCommissionTotals);
  calculateEditCommissionTotals();
}

/* Helpers used in editors */
function addReceiptRow(tbodyId) {
  const tbody = document.getElementById(tbodyId);
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="editable-cell"><input type="text" class="receipt-date" value="" placeholder="dd/mm/yy"></td>
    <td class="editable-cell"><input type="text" value=""></td>
    <td class="editable-cell"><input type="text" class="amount-input" value="‡ß¶"></td>
    <td class="editable-cell"><input type="text" class="amount-input" value="‡ß¶"></td>
  `;
  tbody.appendChild(tr);
  flatpickr(tr.querySelector('.receipt-date'), { dateFormat: "d/m/y", allowInput: true });
  tr.querySelectorAll('.amount-input').forEach(input => {
    input.addEventListener('input', (e)=> e.target.value = e.target.value.replace(/[^‡ß¶-‡ßØ.]/g,''));
  });
}
function deleteLastReceiptRow(tbodyId) {
  const tbody = document.getElementById(tbodyId);
  if (tbody.children.length > 1) {
    tbody.removeChild(tbody.lastChild);
    calculateReceiptTotalsEdit();
    updateBalancesEdit();
    updateVerificationSummaryEdit();
  } else {
    alert('‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶æ‡¶∞‡¶ø ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá ‡¶π‡¶¨‡ßá!');
  }
}
function generateVoucherNumbersEdit() {
  const tbody = document.getElementById('edit-expense-body');
  const rows = tbody.querySelectorAll('tr');
  if (!rows.length) return alert('‡¶ï‡ßã‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á‡•§');
  const firstInput = rows[0].children[2].querySelector('input');
  let startNum = parseInt(toLatinNumerals(firstInput?.value || ''),10);
  if (isNaN(startNum)) startNum = 1;
  rows.forEach((row,i) => {
    const cell = row.children[2];
    const input = cell?.querySelector('input');
    if (input) input.value = toBengaliNumerals(String(startNum + i));
  });
}
function generateCheckNumbersEdit() {
  const tbody = document.getElementById('edit-expense-body');
  const rows = tbody.querySelectorAll('tr');
  if (!rows.length) return alert('‡¶ï‡ßã‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á‡•§');
  const firstInput = rows[0].children[4].querySelector('input');
  let startNum = parseInt(toLatinNumerals(firstInput?.value || ''),10);
  if (isNaN(startNum)) startNum = 1;
  rows.forEach((row,i) => {
    const cell = row.children[4];
    const input = cell?.querySelector('input');
    if (input) input.value = toBengaliNumerals(String(startNum + i));
  });
}

/* Receipt totals (editor) ‚Äî mirrors pettycash-statement logic */
function calculateReceiptTotalsEdit() {
  let openingBank = 0, openingCash = 0;
  let currentBank = 0, currentCash = 0;
  let totalBank = 0, totalCash = 0;

  const rows = document.querySelectorAll('#edit-receipt-body tr');
  rows.forEach((tr, index) => {
    const inputs = tr.querySelectorAll('input');
    if (inputs.length === 4) { // Only count manual rows, not dynamic contra rows
      const bankVal = parseFloat(toLatinNumerals(inputs[2].value)) || 0;
      const cashVal = parseFloat(toLatinNumerals(inputs[3].value)) || 0;
      if (index === 0) { openingBank = bankVal; openingCash = cashVal; }
      else { currentBank += bankVal; currentCash += cashVal; }
      totalBank += bankVal; totalCash += cashVal;
    }
  });

  document.getElementById('summary-opening-bank').value = toBengaliNumerals(openingBank.toFixed(2));
  document.getElementById('summary-opening-cash').value = toBengaliNumerals(openingCash.toFixed(2));

  const currentCashEl = document.getElementById('summary-current-cash-receipt');
  currentCashEl.value = toBengaliNumerals(currentCash.toFixed(2));
  currentCashEl.dataset.baseline = currentCash.toFixed(2); // Set baseline for contra

  document.getElementById('summary-current-bank-receipt').value = toBengaliNumerals(currentBank.toFixed(2));
  document.getElementById('summary-total-bank-fund').value = toBengaliNumerals((openingBank + currentBank).toFixed(2));
  document.getElementById('summary-total-cash-fund').value = toBengaliNumerals((openingCash + currentCash).toFixed(2));

  document.getElementById('edit-receipt-bank-total').textContent = toBengaliNumerals(totalBank.toFixed(2));
  const cashFooterEl = document.getElementById('edit-receipt-cash-total');
  cashFooterEl.textContent = toBengaliNumerals(totalCash.toFixed(2));
  cashFooterEl.dataset.baseline = totalCash.toFixed(2); // Set baseline for contra
}

/* Expense totals (editor) ‚Äî mirrors pettycash-statement output including contra */
function calculateExpenseTotalsEdit() {
  const table = document.querySelector('#editor-container .expense-table table');
  if (!table) {
      console.error("Expense table not found in #editor-container.");
      return; 
  }
  const thead = table.querySelector('thead tr');
  const tfoot = table.querySelector('tfoot tr');
  if (!thead || !tfoot) {
      console.error("Thead or tfoot not found.");
      return;
  }
  const numCols = thead.children.length; // Should be 38

  let totalBankExpense = 0, totalCashExpense = 0, grandTotal = 0, totalContra = 0;
  const colTotals = new Array(numCols).fill(0);

  document.querySelectorAll('#edit-expense-body tr').forEach(tr => {
    const inputs = tr.querySelectorAll('input');
    if (inputs.length < numCols) { // Check if row has all 38 inputs
        console.warn("Skipping row, unexpected number of inputs:", inputs.length);
        return; 
    }
    
    const bank = parseFloat(toLatinNumerals(inputs[3].value)) || 0;
    const cash = parseFloat(toLatinNumerals(inputs[5].value)) || 0;
    const total = parseFloat(toLatinNumerals(inputs[36].value)) || 0; // Index 36 is 'Total'
    const contra = parseFloat(toLatinNumerals(inputs[37].value)) || 0; // Index 37 is 'Contra'

    totalBankExpense += bank;
    totalCashExpense += cash;
    grandTotal += total;
    totalContra += contra;

    // Sum each expense column (from index 6 to 35)
    for (let i = 6; i <= 35; i++) {
      colTotals[i] += parseFloat(toLatinNumerals(inputs[i].value)) || 0;
    }
  });

  // Footer updates
  document.getElementById('expense-bank-total').textContent = toBengaliNumerals(totalBankExpense.toFixed(2));
  document.getElementById('expense-cash-total').textContent = toBengaliNumerals(totalCashExpense.toFixed(2));
  document.getElementById('expense-grand-total').textContent = toBengaliNumerals(grandTotal.toFixed(2));
  document.getElementById('expense-contra-total').textContent = toBengaliNumerals(totalContra.toFixed(2));

  const footerIds = [
    'col-1st-year-commission','col-renewal-commission','col-production-bonus',
    'col-employee-salary-office','col-employee-salary-dev','col-telephone-bill',
    'col-printing-stationery','col-travel-expense','col-festival-bonus-office',
    'col-festival-bonus-dev','col-medical-fee','col-lunch-office','col-lunch-dev',
    'col-revenue-ticket','col-internet-bill','col-cash-allowance','col-incentive-office',
    'col-incentive-dev','col-boishakhi-office','col-boishakhi-dev','col-shraboni-entertainment',
    'col-general-expense','col-newspaper-bill','col-misc-expense','col-furniture-purchase',
    'col-bonus-commission','col-postal-expense','col-office-rent','col-medical-office',
    'col-employee-bill' // <-- FIX: Added missing 30th column ID
  ];
  
  footerIds.forEach((id, idx) => {
    const el = document.getElementById(id);
    if (el) {
        el.textContent = toBengaliNumerals((colTotals[6 + idx] || 0).toFixed(2));
    } else {
        console.error("Footer cell not found for ID:", id);
    }
  });

  // Summary totals
  document.getElementById('total-bank-expense').value = toBengaliNumerals(totalBankExpense.toFixed(2));
  document.getElementById('total-cash-expense').value = toBengaliNumerals(totalCashExpense.toFixed(2));

  // ================== FIX (PROBLEM 1 & 2) ==================
  // Remove all existing dynamic contra rows
  document.querySelectorAll('.dynamic-contra-row').forEach(row => row.remove());

  // Find all contra entries from the expense table
  const contraEntries = [];
  document.querySelectorAll('#edit-expense-body tr').forEach(tr => {
      const inputs = tr.querySelectorAll('input');
      if (inputs.length < 38) return;
      
      const contraVal = parseFloat(toLatinNumerals(inputs[37].value)) || 0; // Index 37 is 'Contra'
      if (contraVal > 0) {
          const dateVal = inputs[0].value || ''; // This is already in Bengali
          contraEntries.push({
              date: dateVal,
              amount: contraVal
          });
      }
  });

  // Add a new row in receipts for EACH contra entry
  const receiptTbody = document.getElementById('edit-receipt-body');
  contraEntries.forEach(entry => {
      const contraRow = document.createElement('tr');
      contraRow.className = 'dynamic-contra-row';
      contraRow.innerHTML = `
          <td class="editable-cell"><input type="text" class="receipt-date contra-date" value="${entry.date}"></td>
          <td class="static-cell" style="text-align: left; padding-left: 5px;">‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶π‡¶§‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂</td>
          <td class="static-cell">‡ß¶</td>
          <td class="static-cell">${toBengaliNumerals(entry.amount.toFixed(2))}</td>
      `;
      receiptTbody.appendChild(contraRow);
      flatpickr(contraRow.querySelector('.contra-date'), { dateFormat: "d/m/y", allowInput: true });
  });

  // Adjust summary and footer with contra (this part was correct)
  const currentCashEl = document.getElementById('summary-current-cash-receipt');
  const baseline = parseFloat(currentCashEl.dataset.baseline || '0');
  currentCashEl.value = toBengaliNumerals((baseline + totalContra).toFixed(2));

  const openingCash = parseFloat(toLatinNumerals(document.getElementById('summary-opening-cash').value)) || 0;
  document.getElementById('summary-total-cash-fund').value = toBengaliNumerals((openingCash + baseline + totalContra).toFixed(2));

  const receiptCashFooter = document.getElementById('edit-receipt-cash-total');
  const fBaseline = parseFloat(receiptCashFooter.dataset.baseline || '0');
  receiptCashFooter.textContent = toBengaliNumerals((fBaseline + totalContra).toFixed(2));
  // ================== END OF FIX ==================
}

/* Balance + verification (editor) */
function updateBalancesEdit() {
  const totalBankFund = parseFloat(toLatinNumerals(document.getElementById('summary-total-bank-fund').value)) || 0;
  const totalCashFund = parseFloat(toLatinNumerals(document.getElementById('summary-total-cash-fund').value)) || 0;
  const totalBankExpense = parseFloat(toLatinNumerals(document.getElementById('total-bank-expense').value)) || 0;
  const totalCashExpense = parseFloat(toLatinNumerals(document.getElementById('total-cash-expense').value)) || 0;

  const bankBalance = totalBankFund - totalBankExpense;
  const cashBalance = totalCashFund - totalCashExpense;

  document.getElementById('bank-balance').value = toBengaliNumerals(bankBalance.toFixed(2));
  document.getElementById('cash-balance').value = toBengaliNumerals(cashBalance.toFixed(2));
}
function updateVerificationSummaryEdit() {
  const totalBankExpense = parseFloat(toLatinNumerals(document.getElementById('total-bank-expense').value)) || 0;
  const totalCashExpense = parseFloat(toLatinNumerals(document.getElementById('total-cash-expense').value)) || 0;
  const grandTotal = parseFloat(toLatinNumerals(document.getElementById('expense-grand-total').textContent)) || 0;
  const contraTotal = parseFloat(toLatinNumerals(document.getElementById('expense-contra-total').textContent)) || 0;

  const bankCashTotal = totalBankExpense + totalCashExpense;
  const columnTotal = grandTotal + contraTotal;
  const difference = bankCashTotal - columnTotal;

  document.getElementById('verify-bank-cash-total').value = toBengaliNumerals(bankCashTotal.toFixed(2));
  document.getElementById('verify-column-total').value = toBengaliNumerals(columnTotal.toFixed(2));
  const diffInput = document.getElementById('verify-difference');
  diffInput.value = toBengaliNumerals(difference.toFixed(2));
  const parentRow = diffInput.closest('.summary-row.total');
  if (parentRow) parentRow.style.background = (Math.abs(difference) < 0.01) ? '#28a745' : '#e74c3c';
}

/* Commission totals */
function calculateEditCommissionTotals() {
  let totalFirst = 0, totalRenewal = 0, total = 0;
  document.querySelectorAll('#edit-commission-body tr').forEach(tr => {
    const inputs = tr.querySelectorAll('input');
    if (inputs.length === 9) {
      const first = parseFloat(toLatinNumerals(inputs[6].value)) || 0;
      const renewal = parseFloat(toLatinNumerals(inputs[7].value)) || 0;
      const rowTotal = first + renewal;
      inputs[8].value = toBengaliNumerals(rowTotal.toFixed(2));
      totalFirst += first; totalRenewal += renewal; total += rowTotal;
    }
  });
  document.getElementById('edit-total-first-year').textContent = toBengaliNumerals(totalFirst.toFixed(2));
  document.getElementById('edit-total-renewal').textContent = toBengaliNumerals(totalRenewal.toFixed(2));
  document.getElementById('edit-total-commission').textContent = toBengaliNumerals(total.toFixed(2));
}

/* Save changes back to archive */
function saveArchiveChanges() {
  if (!currentEditingArchiveId || !currentEditingArchiveType) return;
  const storageKey = currentEditingArchiveType === 'pettycash' ? 'pettyCashArchives' : 'commissionArchives';
  const archives = JSON.parse(localStorage.getItem(storageKey) || '[]');
  const idx = archives.findIndex(a => String(a.id) === String(currentEditingArchiveId));
  if (idx === -1) return;

  if (currentEditingArchiveType === 'pettycash') {
    archives[idx] = savePettycashEditedArchive(archives[idx]);
  } else {
    archives[idx] = saveCommissionEditedArchive(archives[idx]);
  }
  localStorage.setItem(storageKey, JSON.stringify(archives));
  
  // === MODIFIED for this page ===
  alert('‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
  document.getElementById('editor-section').style.display = 'none';
  document.getElementById('editor-container').innerHTML = '';
  document.getElementById('archive-picker-section').style.display = 'block';
  loadArchivePickers(); // Reload lists
  currentEditingArchiveId = null;
  currentEditingArchiveType = null;
  // === END MODIFICATION ===
}

// ================== UPDATED FUNCTION (SAVES SESSION ID) ==================
/* Pettycash save: exact data model retained */
function savePettycashEditedArchive(archive) {
  const updatedData = {
    officeName: document.getElementById('edit-office-name').value,
    officeCode: document.getElementById('edit-office-code').value,
    statementNo: document.getElementById('edit-statement-no').value,
    startDate: document.getElementById('edit-start-date').value,
    endDate: document.getElementById('edit-end-date').value,
    receipts: [],
    expenses: [],
    openingBank: toLatinNumerals(document.getElementById('summary-opening-bank').value) || '0',
    openingCash: toLatinNumerals(document.getElementById('summary-opening-cash').value) || '0',
    totals: {
      summaryOpeningBank: toLatinNumerals(document.getElementById('summary-opening-bank').value) || '0',
      summaryOpeningCash: toLatinNumerals(document.getElementById('summary-opening-cash').value) || '0',
      summaryCurrentBankReceipt: toLatinNumerals(document.getElementById('summary-current-bank-receipt').value) || '0',
      summaryCurrentCashReceipt: toLatinNumerals(document.getElementById('summary-current-cash-receipt').value) || '0',
      summaryTotalBankFund: toLatinNumerals(document.getElementById('summary-total-bank-fund').value) || '0',
      summaryTotalCashFund: toLatinNumerals(document.getElementById('summary-total-cash-fund').value) || '0',
      totalBankExpense: toLatinNumerals(document.getElementById('total-bank-expense').value) || '0',
      totalCashExpense: toLatinNumerals(document.getElementById('total-cash-expense').value) || '0',
      bankBalance: toLatinNumerals(document.getElementById('bank-balance').value) || '0',
      cashBalance: toLatinNumerals(document.getElementById('cash-balance').value) || '0'
    }
  };

  // Save receipts (ignore dynamic contra row which has 1 input)
  document.querySelectorAll('#edit-receipt-body tr').forEach(tr => {
    const inputs = tr.querySelectorAll('input');
    if (inputs.length === 4) {
      updatedData.receipts.push({
        date: inputs[0].value.trim(),
        details: inputs[1].value.trim(),
        bank: toLatinNumerals(inputs[2].value.trim()),
        cash: toLatinNumerals(inputs[3].value.trim())
      });
    }
  });

  // Save expenses per column exactly
  const headerCells = Array.from(document.querySelector('.expense-table thead tr').children).map(th => th.textContent.replace(/‡¶≠‡¶æ‡¶â‡¶ö‡¶æ‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶§‡ßà‡¶∞‡ßÄ ‡¶ï‡¶∞‡ßÅ‡¶®|‡¶ö‡ßá‡¶ï ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶§‡ßà‡¶∞‡ßÄ ‡¶ï‡¶∞‡ßÅ‡¶®/g,'').trim());
  
  document.querySelectorAll('#edit-expense-body tr').forEach(tr => {
    const inputs = tr.querySelectorAll('input');
    if (inputs.length < 38) return; // safety check (now 38 columns)

    const originalId = tr.dataset.originalId;
    const originalManpowerCode = tr.dataset.originalManpowerCode;
    const originalContraFromExpense = parseFloat(tr.dataset.originalContraFromExpense) || 0;
    const originalSessionId = tr.dataset.originalSessionId; // <-- Get the session ID

    const bDate = toLatinNumerals(inputs[0].value.trim());
    let isoDate = '';
    if (bDate && bDate.split('/').length === 3) {
      let [dd, mm, yy] = bDate.split('/');
      if (yy.length === 2) yy = '20' + yy;
      isoDate = `${yy}-${mm}-${dd}`;
    }
    const details = inputs[1].value.trim();
    const voucherNo = toLatinNumerals(inputs[2].value.trim());
    const bankAmount = parseFloat(toLatinNumerals(inputs[3].value)) || 0;
    const checkNo = toLatinNumerals(inputs[4].value.trim());
    
    const contraInputStr = toLatinNumerals(inputs[37].value.trim()) || '0'; // Index 37
    const paymentType = bankAmount > 0 ? 'bank' : 'cash';

    // Push each expense column as separate entries
    for (let i = 6; i <= 35; i++) { // Loop from index 6 to 35 (30 columns)
      const colTitle = headerCells[i];
      const amt = parseFloat(toLatinNumerals(inputs[i].value)) || 0;
      if (amt > 0) {
        const isCommission = colTitle === '‡ßß‡¶Æ ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®' || colTitle === '‡¶®‡¶¨‡¶æ‡¶Ø‡¶º‡¶® ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®';
        
        const expenseEntry = {
          id: originalId,
          manpowerCode: originalManpowerCode,
          manpowerName: details,
          date: isoDate,
          details: details,
          paymentType: paymentType,
          amount: amt.toFixed(2),
          expenseColumn: colTitle,
          voucherNo: voucherNo,
          checkNo: checkNo,
          contraAmount: contraInputStr // Save manual contra value
        };

        if (isCommission && originalSessionId) { // <-- Add session ID back if it's a commission
            expenseEntry.sessionId = originalSessionId;
        }
        
        updatedData.expenses.push(expenseEntry);
      }
    }
    
    if (originalContraFromExpense > 0) {
       updatedData.expenses.push({
          id: originalId,
          manpowerCode: originalManpowerCode,
          manpowerName: details,
          date: isoDate,
          details: details,
          paymentType: paymentType,
          amount: originalContraFromExpense.toFixed(2),
          expenseColumn: '‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶æ',
          voucherNo: voucherNo,
          checkNo: checkNo,
          contraAmount: contraInputStr // Also save manual contra value
      });
    }
  });

  archive.data = updatedData;
  archive.name = `‡¶™‡ßá‡¶ü‡¶ø‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ${updatedData.startDate} - ${updatedData.endDate}`;
  archive.createdAt = new Date().toISOString(); // Update modification time
  return archive;
}

/* Commission save */
function saveCommissionEditedArchive(archive) {
  const startDate = document.getElementById('edit-start-date').value;
  const endDate = document.getElementById('edit-end-date').value;
  let month = "", year = "";
  if (startDate && startDate.split('/').length === 3) {
    month = startDate.split('/')[1];
    year = startDate.split('/')[2];
    if (year.length === 2) year = '20' + year;
  }
  const updatedData = {
    officeName: document.getElementById('edit-office-name').value,
    officeCode: document.getElementById('edit-office-code').value,
    startDate, endDate, month, year,
    entries: [],
    totals: { totalCommission: toLatinNumerals(document.getElementById('edit-total-commission').textContent) || 0 }
  };
  document.querySelectorAll('#edit-commission-body tr').forEach(tr => {
    const inputs = tr.querySelectorAll('input');
    if (inputs.length === 9) {
      updatedData.entries.push({
        serial: toLatinNumerals(inputs[0].value),
        date: inputs[1].value, // keep display format as-is
        agentName: inputs[2].value,
        agentCode: toLatinNumerals(inputs[3].value),
        billNo: toLatinNumerals(inputs[4].value),
        voucherNo: toLatinNumerals(inputs[5].value),
        firstYearComm: toLatinNumerals(inputs[6].value),
        renewalComm: toLatinNumerals(inputs[7].value),
        totalComm: toLatinNumerals(inputs[8].value)
      });
    }
  });
  archive.data = updatedData;
  archive.name = `‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ${startDate} - ${endDate}`;
  archive.createdAt = new Date().toISOString(); // Update modification time
  return archive;
}

/* Delete archive (Not used on this page, but kept for completeness if needed) */
// function deleteArchive(id, type) { ... }


/* === REPLACED FUNCTION: Uses window.print() for reliable PDF generation === */
function exportToPDF() {
  const editorContainer = document.getElementById('editor-container');
  if (!editorContainer) return alert('‡¶è‡¶°‡¶ø‡¶ü‡¶∞ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!');
  
  const printWrapper = document.getElementById('print-wrapper');
  if (!printWrapper) {
    console.error('‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶™‡¶æ‡¶∞ (#print-wrapper) ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!');
    return alert('‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
  }

  // Clone the editor content
  const clone = editorContainer.cloneNode(true);
  
  // Replace all inputs with static text (spans) for printing
  clone.querySelectorAll('input').forEach(input => {
    const span = document.createElement('span');
    span.textContent = input.value || ''; // Use the value directly, it's already Bengali
    
    // Apply some basic styles from the input
    span.style.display = 'inline-block';
    
    // === FIX FOR FIELD WIDTHS ===
    // If the input has an inline style for width (like in the header), use it.
    // Otherwise, make it 100% to fill its table cell.
    if (input.style.width) {
      span.style.width = input.style.width;
    } else {
      span.style.width = '100%';
    }
    // === END FIX ===

    span.style.fontFamily = 'inherit';
    span.style.fontWeight = 'bold';
    
    // Match alignment
    const computedStyle = window.getComputedStyle(input);
    span.style.textAlign = computedStyle.textAlign || 'center';
    
    // Special alignment cases from original code
    if (input.closest('.summary-value')) {
        span.style.textAlign = 'right';
    }
    if (input.id && (input.id.includes('edit-office-name') || input.id.includes('edit-office-code'))) {
        span.style.textAlign = 'left';
    }
    
    input.parentNode.replaceChild(span, input);
  });

  // Hide all buttons inside the clone
  clone.querySelectorAll('.receipt-buttons, button').forEach(el => {
    el.style.display = 'none';
  });
  
  // Put the prepared clone into the print wrapper
  printWrapper.innerHTML = ''; // Clear previous
  printWrapper.appendChild(clone);

  // Call the browser's print dialog
  window.print();
  
  // The print wrapper will be cleared on the *next* print
}

/* Generate sequential numbers utility (used in commission editor) */
function generateSequentialNumbers(tbodyId, columnIndex, useFirstAsStart = false) {
  const tbody = document.getElementById(tbodyId);
  if (!tbody) return alert('Table body not found!');
  const rows = tbody.querySelectorAll('tr');
  if (!rows.length) return alert('‡¶ï‡ßã‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á‡•§');

  let startNum = 1;
  if (useFirstAsStart && rows[0].children[columnIndex]) {
    const firstInput = rows[0].children[columnIndex].querySelector('input');
    if (firstInput) {
      startNum = parseInt(toLatinNumerals(firstInput.value), 10);
      if (isNaN(startNum)) startNum = 1;
    }
  }
  rows.forEach((row, idx) => {
    const cell = row.children[columnIndex];
    const input = cell?.querySelector('input');
    if (input) input.value = toBengaliNumerals((startNum + idx).toString());
  });
  if (tbodyId === 'edit-commission-body') calculateEditCommissionTotals();
}

/* === PAGE INITIALIZATION === */
document.addEventListener('DOMContentLoaded', () => {
  loadArchivePickers();
});
</script>
</body>
</html>